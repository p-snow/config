<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Utility Programs (.bin)</title>
<meta name="generator" content="Org mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">Utility Programs (.bin)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge599bba">Declutters</a></li>
<li><a href="#org78418ac">Database back-up scripts</a></li>
<li><a href="#orgaa64b51">Snapshots taking</a></li>
<li><a href="#org8746cbe">backup scripts</a></li>
<li><a href="#org587e947">filetype</a></li>
<li><a href="#org6ac51e4">mediautil</a></li>
<li><a href="#org9996d96">genalbum</a></li>
<li><a href="#orgd76e9f1">nhp</a></li>
<li><a href="#org2bbb8e2">sendmail.py</a></li>
<li><a href="#org7633708">pwsudo</a></li>
<li><a href="#org8efcac8">gitsync</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge599bba" class="outline-2">
<h2 id="orge599bba">Declutters</h2>
<div class="outline-text-2" id="text-orge599bba">
<p>
These scripts (declutter<sub>xxx</sub>) keep things decluttered.
</p>

<ul class="org-ul">
<li><p>
trash
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>

<span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> time
<span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">import</span> shutil
<span style="font-weight: bold;">import</span> glob
<span style="font-weight: bold;">from</span> send2trash <span style="font-weight: bold;">import</span> send2trash

<span style="font-weight: bold; font-style: italic;">TRASH_DIR</span> = os.environ[<span style="font-style: italic;">'HOME'</span>] + <span style="font-style: italic;">'/.local/share/Trash/files/'</span>
<span style="font-weight: bold; font-style: italic;">TIDY_DIRS</span> = <span style="font-weight: bold;">filter</span>(<span style="font-weight: bold;">lambda</span> x: os.path.isdir(x),
                   <span style="font-weight: bold;">list</span>(<span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> x: os.path.join(os.environ[<span style="font-style: italic;">'HOME'</span>], x), [<span style="font-style: italic;">'tmp'</span>, <span style="font-style: italic;">'Downloads'</span>]))
                   + glob.glob(os.path.join(os.environ[<span style="font-style: italic;">'HOME'</span>], <span style="font-style: italic;">'var/tmp/*'</span>)))

<span style="font-weight: bold; font-style: italic;">MAX_STAY_DAYS_IN_TRASH</span> = 7
<span style="font-weight: bold; font-style: italic;">MAX_NEGLECTED_DAYS_IN_TIDY_DIRS</span> = 14

<span style="font-weight: bold; font-style: italic;">suffixes</span> = [<span style="font-style: italic;">'B'</span>, <span style="font-style: italic;">'KB'</span>, <span style="font-style: italic;">'MB'</span>, <span style="font-style: italic;">'GB'</span>, <span style="font-style: italic;">'TB'</span>, <span style="font-style: italic;">'PB'</span>]
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">humansize</span>(nbytes):
    <span style="font-weight: bold; font-style: italic;">i</span> = 0
    <span style="font-weight: bold;">while</span> nbytes &gt;= 1024 <span style="font-weight: bold;">and</span> i &lt; <span style="font-weight: bold;">len</span>(suffixes)-1:
        <span style="font-weight: bold; font-style: italic;">nbytes</span> /= 1024.
        <span style="font-weight: bold; font-style: italic;">i</span> += 1
    <span style="font-weight: bold; font-style: italic;">f</span> = (<span style="font-style: italic;">'%.2f'</span> % nbytes).rstrip(<span style="font-style: italic;">'0'</span>).rstrip(<span style="font-style: italic;">'.'</span>)
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'%s %s'</span> % (f, suffixes[i])

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_size</span>(start_path = <span style="font-style: italic;">'.'</span>):
    <span style="font-weight: bold; font-style: italic;">total_size</span> = 0
    <span style="font-weight: bold;">for</span> dirpath, dirnames, filenames <span style="font-weight: bold;">in</span> os.walk(start_path):
        <span style="font-weight: bold;">for</span> f <span style="font-weight: bold;">in</span> filenames:
            <span style="font-weight: bold; font-style: italic;">fp</span> = os.path.join(dirpath, f)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">skip if it is symbolic link</span>
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> os.path.islink(fp):
                <span style="font-weight: bold; font-style: italic;">total_size</span> += os.path.getsize(fp)

    <span style="font-weight: bold;">return</span> total_size

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'{0} starts at {1}\n'</span>.<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
                                   datetime.datetime.now()))

<span style="font-weight: bold; font-style: italic;">NOW</span> = time.time()

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'--{0} starts to move files neglected more than {1} days to trash box.\n'</span>
      .<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
              MAX_NEGLECTED_DAYS_IN_TIDY_DIRS))

<span style="font-weight: bold; font-style: italic;">tidyup_lists</span> = <span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> x: <span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> y: os.path.join(x, y), os.listdir(x)), TIDY_DIRS)
<span style="font-weight: bold;">for</span> a_file <span style="font-weight: bold;">in</span> [item <span style="font-weight: bold;">for</span> sublist <span style="font-weight: bold;">in</span> tidyup_lists <span style="font-weight: bold;">for</span> item <span style="font-weight: bold;">in</span> sublist]:
    <span style="font-weight: bold; font-style: italic;">atime</span> = os.lstat(a_file).st_atime
    <span style="font-weight: bold; font-style: italic;">delta_atime</span> = datetime.timedelta(seconds=(NOW - atime))
    <span style="font-weight: bold;">if</span> delta_atime &gt; datetime.timedelta(days = MAX_NEGLECTED_DAYS_IN_TIDY_DIRS):
        <span style="font-weight: bold;">try</span>:
            send2trash(a_file)
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">OSError</span> <span style="font-weight: bold;">as</span> error:
            <span style="font-weight: bold;">print</span>(error)
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'moveed to trash: {}'</span>.<span style="font-weight: bold;">format</span>(a_file))

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'--{0} starts to remove files staying more than {1} days in trash box.'</span>
      .<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
              MAX_STAY_DAYS_IN_TRASH))

<span style="font-weight: bold; font-style: italic;">rbytes_total</span> = 0
<span style="font-weight: bold;">for</span> trash_file <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> fname: os.path.join(TRASH_DIR, fname), os.listdir(TRASH_DIR)):
    <span style="font-weight: bold; font-style: italic;">lstat</span> = os.lstat(trash_file)
    <span style="font-weight: bold; font-style: italic;">delta_time</span> = datetime.timedelta(seconds=(NOW - <span style="font-weight: bold;">max</span>(lstat.st_atime, lstat.st_ctime)))
    <span style="font-weight: bold;">if</span> delta_time &gt; datetime.timedelta(days = MAX_STAY_DAYS_IN_TRASH):
        <span style="font-weight: bold; font-style: italic;">method</span> = <span style="font-style: italic;">'removed'</span>
        <span style="font-weight: bold; font-style: italic;">fname</span> = os.path.basename(trash_file)
        <span style="font-weight: bold;">if</span> os.path.islink(trash_file):
            <span style="font-weight: bold; font-style: italic;">method</span> = <span style="font-style: italic;">'unlinked'</span>
            <span style="font-weight: bold; font-style: italic;">fsize</span> = <span style="font-style: italic;">'N/A'</span>
            os.unlink(trash_file)
        <span style="font-weight: bold;">elif</span> os.path.isfile(trash_file):
            <span style="font-weight: bold; font-style: italic;">rbytes</span> = os.path.getsize(trash_file)
            <span style="font-weight: bold; font-style: italic;">rbytes_total</span> += rbytes
            <span style="font-weight: bold; font-style: italic;">fsize</span> = humansize(rbytes)
            os.remove(trash_file)
        <span style="font-weight: bold;">elif</span> os.path.isdir(trash_file):
            <span style="font-weight: bold; font-style: italic;">rbytes</span> = get_size(trash_file)
            <span style="font-weight: bold; font-style: italic;">rbytes_total</span> += rbytes
            <span style="font-weight: bold; font-style: italic;">fsize</span> = humansize(rbytes)
            <span style="font-weight: bold; font-style: italic;">fname</span> += <span style="font-style: italic;">'/'</span>
            shutil.rmtree(trash_file)
        <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'{}: [{:&gt;9}] {}'</span>.<span style="font-weight: bold;">format</span>(method, fsize, fname))

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'--{0} removes [{1}] in total.\n'</span>
      .<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
              humansize(rbytes_total)))

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'{0} ends at {1}\n'</span>.<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
                                 datetime.datetime.now()))
</pre>
</div></li>
<li><p>
home directory (ruby implementation)
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env ruby</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">coding: utf-8</span>

<span style="font-weight: bold; text-decoration: underline;">TRASHES</span> = [<span style="font-style: italic;">"*~"</span>, <span style="font-style: italic;">"#*#"</span>, <span style="font-style: italic;">".#*#"</span>, <span style="font-style: italic;">"._*"</span>, <span style="font-style: italic;">".DS_Store"</span>]

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Sweep</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">sweep</span>(base_dir)
    <span style="font-weight: bold;">puts</span> base_dir
    <span style="font-weight: bold; text-decoration: underline;">TRASHES</span>.each <span style="font-weight: bold;">do</span> |trash|
      tfiles = <span style="font-weight: bold; text-decoration: underline;">File</span>.join(<span style="font-style: italic;">"%s/**"</span> % base_dir, trash)
      <span style="font-weight: bold; text-decoration: underline;">Dir</span>.glob(tfiles).each <span style="font-weight: bold;">do</span> |f|
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">File</span>.delete(f) &gt; 0
          <span style="font-weight: bold;">puts</span> <span style="font-style: italic;">"Removed: "</span> + f
        <span style="font-weight: bold;">else</span>
          <span style="font-weight: bold;">puts</span> <span style="font-style: italic;">"CANNOT Removed: "</span> + f
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold; text-decoration: underline;">ARGV</span>.each <span style="font-weight: bold;">do</span> |arg|
  <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">Dir</span>.exist?(arg) <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; text-decoration: underline;">Sweep</span>.sweep(arg)
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>
</pre>
</div></li>
<li><p>
home directory (python implementation)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>

<span style="font-weight: bold;">import</span> sys
<span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> glob
<span style="font-weight: bold;">import</span> argparse

<span style="font-weight: bold; font-style: italic;">TRASH_REGEXPS</span> = [<span style="font-style: italic;">"*~"</span>, <span style="font-style: italic;">"#*"</span>, <span style="font-style: italic;">".#*"</span>, <span style="font-style: italic;">"._*"</span>, <span style="font-style: italic;">".DS_Store"</span>, <span style="font-style: italic;">"*.dvi"</span>, <span style="font-style: italic;">"*.aux"</span>, <span style="font-style: italic;">"*.bbl"</span>]

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Sweepy</span>:
    <span style="font-weight: bold; text-decoration: underline;">@classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">sweep_with_regexp</span>(<span style="font-weight: bold;">self</span>, base_dir, recursive=<span style="font-weight: bold; text-decoration: underline;">False</span>):
        <span style="font-weight: bold;">for</span> trash_regexp <span style="font-weight: bold;">in</span> TRASH_REGEXPS:
            <span style="font-weight: bold; font-style: italic;">files</span> = glob.glob(<span style="font-style: italic;">"%s/**/"</span> % base_dir + trash_regexp, recursive=recursive)
            <span style="font-weight: bold;">for</span> <span style="font-weight: bold;">file</span> <span style="font-weight: bold;">in</span> files:
                <span style="font-weight: bold;">if</span> os.path.isfile(<span style="font-weight: bold;">file</span>):
                    os.remove(<span style="font-weight: bold;">file</span>)
                    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"Removed: "</span> + <span style="font-weight: bold;">file</span>)
    <span style="font-weight: bold; text-decoration: underline;">@classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">sweep_broken_symlink</span>(<span style="font-weight: bold;">self</span>, base_dir, recursive=<span style="font-weight: bold; text-decoration: underline;">False</span>):
        <span style="font-weight: bold; font-style: italic;">files</span> = glob.glob(<span style="font-style: italic;">"%s/*"</span> % base_dir, recursive=recursive)
        <span style="font-weight: bold; font-style: italic;">dotfiles</span> = glob.glob(<span style="font-style: italic;">"%s/.*"</span> % base_dir, recursive=recursive)
        <span style="font-weight: bold;">for</span> <span style="font-weight: bold;">file</span> <span style="font-weight: bold;">in</span> (files + dotfiles):
            <span style="font-weight: bold;">if</span> os.path.islink(<span style="font-weight: bold;">file</span>):
                <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> os.path.exists(os.readlink(<span style="font-weight: bold;">file</span>)):
                    os.unlink(<span style="font-weight: bold;">file</span>)
                    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"Unlinked: "</span> + <span style="font-weight: bold;">file</span>)

<span style="font-weight: bold; font-style: italic;">parser</span> = argparse.ArgumentParser(description=<span style="font-style: italic;">'Removes all desired files'</span>)
parser.add_argument(<span style="font-style: italic;">'dir'</span>, metavar=<span style="font-style: italic;">'dir'</span>, nargs=<span style="font-style: italic;">'?'</span>, action=<span style="font-style: italic;">'store'</span>,
                    <span style="font-weight: bold;">help</span>=<span style="font-style: italic;">'base directory to search'</span>)
parser.add_argument(<span style="font-style: italic;">'-r'</span>, dest=<span style="font-style: italic;">'recursive'</span>, action=<span style="font-style: italic;">"store_true"</span>, default=<span style="font-weight: bold; text-decoration: underline;">False</span>)
<span style="font-weight: bold; font-style: italic;">args</span> = parser.parse_args()
<span style="font-weight: bold;">if</span> args.recursive:
    Sweepy.sweep_with_regexp(args.<span style="font-weight: bold;">dir</span>, recursive=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    Sweepy.sweep_broken_symlink(args.<span style="font-weight: bold;">dir</span>, recursive=<span style="font-weight: bold; text-decoration: underline;">True</span>)
<span style="font-weight: bold;">else</span>:
    Sweepy.sweep_with_regexp(args.<span style="font-weight: bold;">dir</span>, recursive=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    Sweepy.sweep_broken_symlink(args.<span style="font-weight: bold;">dir</span>, recursive=<span style="font-weight: bold; text-decoration: underline;">False</span>)
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org78418ac" class="outline-2">
<h2 id="org78418ac">Database back-up scripts</h2>
<div class="outline-text-2" id="text-org78418ac">
<ul class="org-ul">
<li><p>
PostgreSQL
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Usage: $ postgres_backup &lt;db_name&gt; &lt;backup_dir&gt;</span>

<span style="font-weight: bold; font-style: italic;">POSTGRES_DBNAME</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
<span style="font-weight: bold; font-style: italic;">BACKUP_DIR</span>=$<span style="font-weight: bold; font-style: italic;">2</span>
<span style="font-weight: bold; font-style: italic;">DATE</span>=<span style="font-style: italic;">"$(date +%Y%m%d_%H%M)"</span>

pg_dump --format=custom ${<span style="font-weight: bold; font-style: italic;">POSTGRES_DBNAME</span>} &gt; ${<span style="font-weight: bold; font-style: italic;">BACKUP_DIR</span>}/${<span style="font-weight: bold; font-style: italic;">DATE</span>}_${<span style="font-weight: bold; font-style: italic;">POSTGRES_DBNAME</span>}.custom || <span style="font-weight: bold;">exit</span> 1

<span style="font-weight: bold;">exit</span> 0
</pre>
</div></li>

<li><p>
MySQL
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">BACKUP_DIR</span>=~/var/backups/mysql
<span style="font-weight: bold; font-style: italic;">RAW_SQL</span>=<span style="font-style: italic;">"$(date +%Y%m%d_%H%M)_backup.sql"</span>
<span style="font-weight: bold; font-style: italic;">TAR_SQL</span>=<span style="font-style: italic;">"${RAW_SQL}.txz"</span>

(
  <span style="font-weight: bold;">cd</span> <span style="font-style: italic;">"${BACKUP_DIR}"</span> || <span style="font-weight: bold;">exit</span> 1
  mysqldump --opt --all-databases --events --default-character-set=binary -u root &gt; <span style="font-style: italic;">"${RAW_SQL}"</span>
  tar cfJ <span style="font-style: italic;">"${TAR_SQL}"</span> <span style="font-style: italic;">"${RAW_SQL}"</span>
  rm -f <span style="font-style: italic;">"${RAW_SQL}"</span>
) || <span style="font-weight: bold;">exit</span> 1

<span style="font-weight: bold;">exit</span> 0
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgaa64b51" class="outline-2">
<h2 id="orgaa64b51">Snapshots taking</h2>
<div class="outline-text-2" id="text-orgaa64b51">
<ul class="org-ul">
<li><p>
snapshot.sh
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">DATETIME</span>=<span style="font-weight: bold;">`date "+%Y%m%d-%H%M"`</span>
<span style="font-weight: bold; font-style: italic;">BTRFS_MNT</span>=<span style="font-style: italic;">"/mnt/ssd01"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">take a snapshot in btrfs</span>
<span style="font-weight: bold;">if</span> mountpoint ${<span style="font-weight: bold; font-style: italic;">BTRFS_MNT</span>} &gt;/dev/null 2&gt;&amp;1; <span style="font-weight: bold;">then</span>
  btrfs subvolume snapshot <span style="font-style: italic;">"${BTRFS_MNT}/doc"</span> <span style="font-style: italic;">"${BTRFS_MNT}/snapshots/doc-${DATETIME}"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8746cbe" class="outline-2">
<h2 id="org8746cbe">backup scripts</h2>
<div class="outline-text-2" id="text-org8746cbe">
<ul class="org-ul">
<li><p>
back<sub>btrfs.sh</sub>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">src_dev</span>=/mnt/ssd01
<span style="font-weight: bold; font-style: italic;">src_snap_dir</span>=<span style="font-style: italic;">"${src_dev}"</span>/snapshots
<span style="font-weight: bold; font-style: italic;">src_back_dir</span>=<span style="font-style: italic;">"${src_dev}"</span>/backups
<span style="font-weight: bold; font-style: italic;">dst_dev</span>=/mnt/hdd01
<span style="font-weight: bold; font-style: italic;">dst_back_dir</span>=<span style="font-style: italic;">"${dst_dev}"</span>/backups

<span style="font-weight: bold; font-style: italic;">parent</span>=$(ls -d <span style="font-style: italic;">"${src_back_dir}"</span>/doc-* 2&gt;/dev/null | sort | tail -1 | xargs basename)
<span style="font-weight: bold; font-style: italic;">snap_earliest</span>=$(ls -d <span style="font-style: italic;">"${src_snap_dir}"</span>/doc-* 2&gt;/dev/null | sort | head -1 | xargs basename)
<span style="font-weight: bold; font-style: italic;">snap_latest</span>=$(ls -d <span style="font-style: italic;">"${src_snap_dir}"</span>/doc-* 2&gt;/dev/null | sort | tail -1 | xargs basename)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">backup root snapshot if nothing exists</span>
<span style="font-weight: bold;">if</span> [ -z <span style="font-style: italic;">"${parent}"</span> ] &amp;&amp; [ -n <span style="font-style: italic;">"${snap_earliest}"</span> ]; <span style="font-weight: bold;">then</span>
  btrfs subvolume snapshot -r <span style="font-style: italic;">"${src_snap_dir}/${snap_earliest}"</span> <span style="font-style: italic;">"${src_back_dir}/${snap_earliest}"</span>
  pwsudo btrfs send <span style="font-style: italic;">"${src_back_dir}/${snap_earliest}"</span> | sudo btrfs receive <span style="font-style: italic;">"${dst_back_dir}"</span>
  <span style="font-weight: bold; font-style: italic;">parent</span>=<span style="font-style: italic;">"${snap_earliest}"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">backup latest snapshot by sending differential data</span>
<span style="font-weight: bold;">if</span> [ -n <span style="font-style: italic;">"${parent}"</span> ] &amp;&amp; [[ <span style="font-style: italic;">"${parent}"</span> &lt; <span style="font-style: italic;">"${snap_latest}"</span> ]]; <span style="font-weight: bold;">then</span>
  btrfs subvolume snapshot  -r <span style="font-style: italic;">"${src_snap_dir}/${snap_latest}"</span> <span style="font-style: italic;">"${src_back_dir}/${snap_latest}"</span>
  pwsudo btrfs send -p <span style="font-style: italic;">"${src_back_dir}/${parent}"</span> <span style="font-style: italic;">"${src_back_dir}/${snap_latest}"</span> | sudo btrfs receive <span style="font-style: italic;">"${dst_back_dir}"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div></li>
<li><p>
back<sub>rsync.sh</sub>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">OPT</span>=<span style="font-style: italic;">"-aPh"</span>
<span style="font-weight: bold; font-style: italic;">LINK</span>=<span style="font-style: italic;">"--link-dest=../last/"</span>
<span style="font-weight: bold; font-style: italic;">DEST</span>=<span style="font-style: italic;">"ns01:~/share/backups"</span>
<span style="font-weight: bold; font-style: italic;">DATETIME</span>=<span style="font-weight: bold;">`date "+%Y%m%d-%H%M"`</span>

ssh -q -o <span style="font-weight: bold; font-style: italic;">BatchMode</span>=<span style="font-style: italic;">"yes"</span> -o <span style="font-weight: bold; font-style: italic;">ConnectTimeout</span>=10 ns01 <span style="font-style: italic;">"(cd ~/share/backups; mkdir -p pc01 sv04; exit)"</span> || <span style="font-weight: bold;">exit</span> 1

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">take a snapshot for pc01</span>
<span style="font-weight: bold;">if</span> ssh ns01 <span style="font-style: italic;">"[ -h ~/share/backups/pc01/last ]"</span>; <span style="font-weight: bold;">then</span>
  rsync -aPhrv $<span style="font-weight: bold; font-style: italic;">LINK</span> --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_pc01.txt ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/pc01/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
  ssh ns01 <span style="font-style: italic;">"(cd share/backups/pc01; unlink last; ln -s ${DATETIME} last)"</span>
<span style="font-weight: bold;">else</span>
  rsync -aAXrv --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_pc01.txt ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/pc01/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
  ssh ns01 <span style="font-style: italic;">"(cd share/backups/pc01; ln -s ${DATETIME} last)"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">take a snapshot for sv04</span>
<span style="font-weight: bold;">if</span> mountpoint /mnt/sv04 &gt;/dev/null 2&gt;&amp;1; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">if</span> ssh ns01 <span style="font-style: italic;">"[ -h ~/share/backups/sv04/last ]"</span>; <span style="font-weight: bold;">then</span>
    rsync -aPhrv $<span style="font-weight: bold; font-style: italic;">LINK</span> --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_sv04.txt /mnt/sv04/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/sv04/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
    ssh ns01 <span style="font-style: italic;">"(cd share/backups/sv04; unlink last; ln -s ${DATETIME} last)"</span>
  <span style="font-weight: bold;">else</span>
    rsync -aAXrv --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_sv04.txt /mnt/sv04/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/sv04/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
    ssh ns01 <span style="font-style: italic;">"(cd share/backups/sv04; ln -s ${DATETIME} last)"</span>
  <span style="font-weight: bold;">fi</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>
<ul class="org-ul">
<li><p>
rsync exclude file for pc01
</p>
<div class="org-src-container">
<pre class="src src-conf">+ var
+ var/log
+ var/log/**
- var/lib/dash
+ var/lib
+ var/lib/**
+ work
+ work/**
+ git
+ git/**
- *
</pre>
</div></li>
<li><p>
rsync exclude file for sv04
</p>
<div class="org-src-container">
<pre class="src src-conf">+ var
+ var/backup
+ var/backup/**
- *
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org587e947" class="outline-2">
<h2 id="org587e947">filetype</h2>
<div class="outline-text-2" id="text-org587e947">
<p>
This program determine type of the file.
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env ruby</span>

<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'pathname'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'uri'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'shellwords'</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>
  <span style="font-weight: bold; text-decoration: underline;">ZIP_PREFIXES</span> = [<span style="font-style: italic;">'Zip archive data'</span>]

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">type</span>(filename, file_cmd_opt = <span style="font-style: italic;">""</span>)
    <span style="font-weight: bold;">if</span>  <span style="font-weight: bold; text-decoration: underline;">File</span>.exists?(filename)
      local_opt = <span style="font-style: italic;">""</span>
      <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">File</span>.symlink?(filename)
        local_opt += <span style="font-style: italic;">"--dereference"</span>
      <span style="font-weight: bold;">end</span>
      <span style="font-style: italic;">`file --brief </span><span style="font-weight: bold; font-style: italic;">#{file_cmd_opt}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{local_opt}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{Shellwords.shellescape(filename)}</span><span style="font-style: italic;">`</span>.strip
    <span style="font-weight: bold;">elsif</span> filename =~ <span style="font-style: italic;">/https?:\/\/www\.youtube\.com.*/</span>
      <span style="font-style: italic;">`youtube-dl -f worst -q </span><span style="font-weight: bold; font-style: italic;">#{Shellwords.shellescape(filename)}</span><span style="font-style: italic;"> -o - 2&gt;/dev/null | file --brief </span><span style="font-weight: bold; font-style: italic;">#{file_cmd_opt}</span><span style="font-style: italic;"> -`</span>.strip
    <span style="font-weight: bold;">elsif</span> filename =~ <span style="font-weight: bold; text-decoration: underline;">URI</span>::<span style="font-weight: bold; text-decoration: underline;">DEFAULT_PARSER</span>.make_regexp
      <span style="font-style: italic;">`curl --location --range 0-9999 </span><span style="font-weight: bold; font-style: italic;">#{Shellwords.shellescape(filename)}</span><span style="font-style: italic;"> 2&gt;/dev/null | file --brief </span><span style="font-weight: bold; font-style: italic;">#{file_cmd_opt}</span><span style="font-style: italic;"> -`</span>.strip
    <span style="font-weight: bold;">else</span>
      <span style="font-style: italic;">''</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">mime_type</span>(filename)
    type(filename, <span style="font-style: italic;">"--mime-type"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">block_device?</span>(file)
    type(file).start_with?(<span style="font-style: italic;">'block special'</span>) &amp;&amp;
      mime_type(file) == <span style="font-style: italic;">'inode/blockdevice'</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">iso9660?</span>(file)
    mime_type(file) == <span style="font-style: italic;">'application/x-iso9660-image'</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">video_dvd_image?</span>(file)
    iso9660?(file) &amp;&amp; type(file).start_with?(<span style="font-style: italic;">'UDF filesystem data'</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">html?</span>(file)
    type(file).start_with?(<span style="font-style: italic;">"HTML document"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">pdf?</span>(file)
    type(file).start_with?(<span style="font-style: italic;">"PDF document"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">epub?</span>(file)
    type(file) == <span style="font-style: italic;">"EPUB document"</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">mobi?</span>(file)
    type(file).start_with?(<span style="font-style: italic;">"Mobipocket E-book"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">pgp?</span>(file)
    type(file).start_with?(<span style="font-style: italic;">"PGP"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">tarpgp?</span>(file)
    pgp?(file) &amp;&amp; file.end_with?(<span style="font-style: italic;">'.tar.gpg'</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">zip?</span>(file)
    type(file).start_with?(*<span style="font-weight: bold; text-decoration: underline;">ZIP_PREFIXES</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">video?</span>(file)
    mime_type(file).start_with?(<span style="font-style: italic;">"video/"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">audio?</span>(file)
    mime_type(file).start_with?(<span style="font-style: italic;">'audio/'</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">image?</span>(file)
    mime_type(file).start_with?(<span style="font-style: italic;">"image/"</span>)
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">playable?</span>(file)
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">File</span>.directory?(file)
      <span style="font-weight: bold; text-decoration: underline;">Dir</span>.foreach(file) <span style="font-weight: bold;">do</span> |fname|
        <span style="font-weight: bold;">next</span> <span style="font-weight: bold;">if</span> [<span style="font-style: italic;">"."</span>, <span style="font-style: italic;">".."</span>].include?(fname)
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">false</span> <span style="font-weight: bold;">unless</span> playable?(<span style="font-style: italic;">"</span><span style="font-weight: bold; font-style: italic;">#{file}</span><span style="font-style: italic;">/</span><span style="font-weight: bold; font-style: italic;">#{fname}</span><span style="font-style: italic;">"</span>)
      <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold; text-decoration: underline;">true</span>
    <span style="font-weight: bold;">elsif</span> file =~ <span style="font-style: italic;">/https?:\/\/www\.youtube\.com.*/</span>
      <span style="font-weight: bold; text-decoration: underline;">true</span>
    <span style="font-weight: bold;">else</span>
      type(file).start_with?(<span style="font-style: italic;">"ISO Media"</span>, <span style="font-style: italic;">"Audio file"</span>) ||
        mime_type(file).start_with?(<span style="font-style: italic;">"video"</span>, <span style="font-style: italic;">"audio"</span>, <span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">dvd_dir?</span>(file)
    <span style="font-weight: bold; text-decoration: underline;">false</span> <span style="font-weight: bold;">unless</span> mime_type(file) == <span style="font-style: italic;">'inode/directory'</span>
    <span style="font-weight: bold; text-decoration: underline;">File</span>.exist?(<span style="font-weight: bold; text-decoration: underline;">Pathname</span>.new(file).join(<span style="font-style: italic;">"VIDEO_TS"</span>)) ||
      <span style="font-weight: bold; text-decoration: underline;">File</span>.exist?(<span style="font-weight: bold; text-decoration: underline;">Pathname</span>.new(file).join(<span style="font-style: italic;">"video_ts"</span>))
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6ac51e4" class="outline-2">
<h2 id="org6ac51e4">mediautil</h2>
<div class="outline-text-2" id="text-org6ac51e4">
<p>
Utility ruby program for manipulating image, audio and video file.
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env ruby</span>

<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'thor'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'open3'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'fileutils'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'tempfile'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'tmpdir'</span>

<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'filetype'</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MediaUtil</span> &lt; <span style="font-weight: bold; text-decoration: underline;">Thor</span>
  <span style="font-weight: bold; text-decoration: underline;">OUTFILE_SUFFIX</span> = <span style="font-style: italic;">"_out"</span>
  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_VIDEO_EXT</span> = <span style="font-style: italic;">".mkv"</span>

  <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Names</span> &lt; <span style="font-weight: bold; text-decoration: underline;">Struct</span>.new(<span style="font-weight: bold; text-decoration: underline;">:in_f</span>, <span style="font-weight: bold; text-decoration: underline;">:out_f</span>)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">in_file</span>()
      in_f
    <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">out_file</span>(extension = <span style="font-weight: bold; text-decoration: underline;">nil</span>)
      <span style="font-weight: bold;">if</span> out_f
        out_f
      <span style="font-weight: bold;">else</span>
        bn = <span style="font-weight: bold; text-decoration: underline;">File</span>.basename(in_f, <span style="font-style: italic;">".*"</span>).gsub(<span style="font-style: italic;">/ /</span>, <span style="font-style: italic;">'_'</span>)
        ext = ((extension) ? extension : <span style="font-weight: bold; text-decoration: underline;">File</span>.extname(in_file))
        default_out = bn + ext
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">File</span>.file?(default_out)
          10.times <span style="font-weight: bold;">do</span> |i|
            try_name = bn + <span style="font-style: italic;">"_"</span> + (i+1).to_s + ext
            <span style="font-weight: bold;">unless</span> <span style="font-weight: bold; text-decoration: underline;">File</span>.file?(try_name)
              <span style="font-weight: bold;">return</span> try_name
            <span style="font-weight: bold;">end</span>
          <span style="font-weight: bold;">end</span>
        <span style="font-weight: bold;">end</span>
        default_out
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">title</span>()
      <span style="font-weight: bold; text-decoration: underline;">File</span>.basename(out_file, <span style="font-style: italic;">".*"</span>)
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Commander</span> &lt; <span style="font-weight: bold; text-decoration: underline;">Struct</span>.new(<span style="font-weight: bold; text-decoration: underline;">:log</span>, <span style="font-weight: bold; text-decoration: underline;">:dry</span>)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">execute</span>(command)
      <span style="font-weight: bold;">if</span> dry
        <span style="font-weight: bold;">puts</span> command
      <span style="font-weight: bold;">else</span>
        log_str, s_code = <span style="font-weight: bold; text-decoration: underline;">Open3</span>.capture2e(command)
        <span style="font-weight: bold;">if</span> log
          user_cmd = <span style="font-weight: bold;">caller</span>.first.scan(<span style="font-style: italic;">/`(.*)'/</span>).flatten.first.to_s
          log_fname = <span style="font-weight: bold; text-decoration: underline;">Time</span>.now.strftime(<span style="font-style: italic;">"%Y%m%d_%H%M%S_"</span>) + user_cmd + <span style="font-style: italic;">".log"</span>
          <span style="font-weight: bold; text-decoration: underline;">File</span>.open(log_fname, <span style="font-style: italic;">"w"</span>) <span style="font-weight: bold;">do</span> |f|
            f.puts(log_str)
          <span style="font-weight: bold;">end</span>
        <span style="font-weight: bold;">else</span>
          <span style="font-weight: bold;">puts</span> log_str
        <span style="font-weight: bold;">end</span>
        <span style="font-weight: bold;">exit</span> <span style="font-weight: bold; text-decoration: underline;">false</span> <span style="font-weight: bold;">unless</span> s_code.success?
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">exit false</span>
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  class_option <span style="font-weight: bold; text-decoration: underline;">:log</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"L"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:boolean</span>,
               <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"log stdout and stderr instead they reveal in terminal"</span>
  class_option <span style="font-weight: bold; text-decoration: underline;">:dryrun</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"D"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:boolean</span>

  desc <span style="font-style: italic;">"info &lt;file&gt;"</span>, <span style="font-style: italic;">"show information about the video file or DVD directory"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:short</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"s"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:boolean</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">info</span>(target)
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(target) || <span style="font-weight: bold; text-decoration: underline;">FileType</span>.audio?(target)
      commander.execute(<span style="font-style: italic;">"ffprobe \"</span><span style="font-weight: bold; font-style: italic;">#{target}</span><span style="font-style: italic;">\" -hide_banner -show_entries format"</span>)
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(target)
      <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:short</span>]
        commander.execute(<span style="font-style: italic;">"identify </span><span style="font-weight: bold; font-style: italic;">#{target}</span><span style="font-style: italic;">"</span>)
      <span style="font-weight: bold;">else</span>
        commander.execute(<span style="font-style: italic;">"identify -verbose </span><span style="font-weight: bold; font-style: italic;">#{target}</span><span style="font-style: italic;">"</span>)
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.block_device?(target) ||
          <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video_dvd_image?(target) ||
          <span style="font-weight: bold; text-decoration: underline;">FileType</span>.dvd_dir?(target)
      commander.execute(<span style="font-style: italic;">"HandBrakeCLI -i \"</span><span style="font-weight: bold; font-style: italic;">#{target}</span><span style="font-style: italic;">\" --title 0"</span>)
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; text-decoration: underline;">STDERR</span>.puts <span style="font-style: italic;">"Unknown Media Format"</span>
      <span style="font-weight: bold;">exit</span> <span style="font-weight: bold; text-decoration: underline;">false</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  default_command <span style="font-weight: bold; text-decoration: underline;">:encode</span>
  desc <span style="font-style: italic;">"encode"</span>, <span style="font-style: italic;">"encode video file"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:vencoder</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"e"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"libx265|libx264"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"video encoder"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:vquality</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"q"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"24.0"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"video encoding quality"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:vbitrate</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"b"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"1000"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"video encoding bitrate in kbps"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:aencoder</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"E"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"fdk_aac"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"audio encoder"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:aquality</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"Q"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"100.0"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"audio encoding quality"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:abitrate</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"B"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"128"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"audio encoding bitrate in kbps"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:display</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"d"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"1920:1080"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'display (width:height) in which encoded video fit'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:fps</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"f"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"30"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'max frame rate'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:ffmpeg</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">encode</span>()
    equip = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    vconf = aconf = pconf = <span style="font-weight: bold; text-decoration: underline;">nil</span>
    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:vencoder</span>] || options[<span style="font-weight: bold; text-decoration: underline;">:vquality</span>]
      vconf = <span style="font-weight: bold; text-decoration: underline;">VideoConfig</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:vencoder</span>], options[<span style="font-weight: bold; text-decoration: underline;">:vquality</span>], options[<span style="font-weight: bold; text-decoration: underline;">:vbitrate</span>])
    <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:aencoder</span>] || options[<span style="font-weight: bold; text-decoration: underline;">:aquality</span>]
      aconf = <span style="font-weight: bold; text-decoration: underline;">AudioConfig</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:aencoder</span>], options[<span style="font-weight: bold; text-decoration: underline;">:aquality</span>], options[<span style="font-weight: bold; text-decoration: underline;">:abitrate</span>])
    <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:display</span>] || options[<span style="font-weight: bold; text-decoration: underline;">:fps</span>]
      pconf = <span style="font-weight: bold; text-decoration: underline;">PictureConfig</span>.new
      pconf.fit_size(options[<span style="font-weight: bold; text-decoration: underline;">:display</span>]) <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:display</span>]
      pconf.decrease_framerate(options[<span style="font-weight: bold; text-decoration: underline;">:fps</span>]) <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:fps</span>]
    <span style="font-weight: bold;">end</span>

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(equip.in_file) <span style="font-weight: bold;">then</span>
      commander.execute(<span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>.command([<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(equip.in_file, [])],
                                       [<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(equip.out_file, [vconf, aconf, pconf, <span style="font-style: italic;">"-map_metadata 0"</span>, options[<span style="font-weight: bold; text-decoration: underline;">:ffmpeg</span>]])]))
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.audio?(equip.in_file) <span style="font-weight: bold;">then</span>
      commander.execute(<span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>.command([<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(equip.in_file, [])],
                                       [<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(equip.out_file, [aconf])]))
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(equip.in_file) <span style="font-weight: bold;">then</span>
      pconf = <span style="font-weight: bold; text-decoration: underline;">ImageConfig</span>.new
      commander.execute(<span style="font-weight: bold; text-decoration: underline;">ImageMagick</span>.command(equip.in_file,
                                            equip.out_file,
                                            pconf))
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; text-decoration: underline;">STDERR</span>.puts <span style="font-style: italic;">"Unknown Media Format"</span>
      <span style="font-weight: bold;">exit</span> <span style="font-weight: bold; text-decoration: underline;">false</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'cdencode'</span>, <span style="font-style: italic;">'rip and encode CD contents'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:device</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'d'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Device file'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:format</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'f'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'flac,ogg,m4a'</span>, <span style="font-weight: bold; text-decoration: underline;">:default</span> =&gt; <span style="font-style: italic;">'flac:-8'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'formats with additinal argument like compression level'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cdencode</span>()
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    abcde_args = []
    abcde_args &lt;&lt; <span style="font-style: italic;">"-d </span><span style="font-weight: bold; font-style: italic;">#{options[:device]}</span><span style="font-style: italic;">"</span> <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:device</span>]
    abcde_args &lt;&lt; <span style="font-style: italic;">'-a default'</span>
    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:format</span>] <span style="font-weight: bold;">then</span>
      abcde_args &lt;&lt; <span style="font-style: italic;">"-o '</span><span style="font-weight: bold; font-style: italic;">#{options[:format]}</span><span style="font-style: italic;">'"</span>
    <span style="font-weight: bold;">end</span>
    abcde_args &lt;&lt; <span style="font-style: italic;">'-G'</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">getalbumart</span>
    abcde_args &lt;&lt; <span style="font-style: italic;">'-x'</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Eject CD</span>

    commander.execute(<span style="font-style: italic;">"abcde </span><span style="font-weight: bold; font-style: italic;">#{abcde_args.join(' ')}</span><span style="font-style: italic;">"</span>)
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'dvdrip'</span>, <span style="font-style: italic;">'rip(backup) DVD contents'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:device</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'d'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'DVD device file'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'o'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'output directory name'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:name</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'n'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'root directory name of backup data'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">dvdrip</span>()
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    dvdbackup_opts = [<span style="font-style: italic;">'dvdbackup'</span>]
    dvdbackup_opts &lt;&lt; <span style="font-style: italic;">'--input=%s'</span> % options[<span style="font-weight: bold; text-decoration: underline;">:device</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:device</span>]
    dvdbackup_opts &lt;&lt; <span style="font-style: italic;">'--output=%s'</span> % options[<span style="font-weight: bold; text-decoration: underline;">:out</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:out</span>]
    dvdbackup_opts &lt;&lt; <span style="font-style: italic;">'--name=%s'</span> % options[<span style="font-weight: bold; text-decoration: underline;">:name</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:name</span>]
    dvdbackup_opts &lt;&lt; <span style="font-style: italic;">'--mirror'</span>
    dvdbackup_opts &lt;&lt; <span style="font-style: italic;">'--progress'</span>
    dvdbackup_opts &lt;&lt; <span style="font-style: italic;">'--verbose'</span>

    commander.execute(dvdbackup_opts.join(<span style="font-style: italic;">' '</span>))
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'dvdencode'</span>, <span style="font-style: italic;">'encode DVD contents'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'i'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'input source, DVD device file or backuped DVD file'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'o'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'output directory name'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:vencoder</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"e"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"x265|x264"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"video encoder"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:vquality</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"q"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"24.0"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"video encoding quality"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:vbitrate</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"b"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"1000"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"video bitrate in kbps"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:aencoder</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"E"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"fdk_aac"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"audio encoder"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:aquality</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"Q"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"100.0"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"audio encoding quality"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:abitrate</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"B"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"128"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"audio bitrate in kbps"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:title</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'t'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'1|2|3|...'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'title number'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:chapters</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'c'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'1|1-3|1,3,5|...'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'chapter numbers'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:audio</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'a'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'1,2,3'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'audio channel'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:subtitle</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'s'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'1,2'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'subtitle channel'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:handbrake</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'--handbrake \"--mixdown 5point1,stereo\"'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'HandBrakeCLI options'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">dvdencode</span>()
    equip = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.block_device?(equip.in_file) ||
       <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video_dvd_image?(equip.in_file) ||
       <span style="font-weight: bold; text-decoration: underline;">FileType</span>.dvd_dir?(equip.in_file)
      configs = []
      configs &lt;&lt; <span style="font-weight: bold; text-decoration: underline;">VideoConfig</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:vencoder</span>], options[<span style="font-weight: bold; text-decoration: underline;">:vquality</span>], options[<span style="font-weight: bold; text-decoration: underline;">:vbitrate</span>])
      configs &lt;&lt; <span style="font-weight: bold; text-decoration: underline;">AudioConfig</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:aencoder</span>], options[<span style="font-weight: bold; text-decoration: underline;">:aquality</span>], options[<span style="font-weight: bold; text-decoration: underline;">:abitrate</span>])
      dconf = <span style="font-weight: bold; text-decoration: underline;">DVDConfig</span>.new
      dconf.title = options[<span style="font-weight: bold; text-decoration: underline;">:title</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:title</span>]
      dconf.chapters = options[<span style="font-weight: bold; text-decoration: underline;">:chapters</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:chapters</span>]
      dconf.audio = options[<span style="font-weight: bold; text-decoration: underline;">:audio</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:audio</span>]
      dconf.subtitle = options[<span style="font-weight: bold; text-decoration: underline;">:subtitle</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:subtitle</span>]
      configs &lt;&lt; dconf
      commander.execute(<span style="font-weight: bold; text-decoration: underline;">HandBrakeCLI</span>.command(equip.in_file,
                                             equip.out_file(<span style="font-weight: bold; text-decoration: underline;">DEFAULT_VIDEO_EXT</span>),
                                             configs,
                                             options[<span style="font-weight: bold; text-decoration: underline;">:handbrake</span>]))
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'mount &lt;dir&gt;'</span>, <span style="font-style: italic;">'Mount CD/DVD media to dir.'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:device</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"d"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'device or iso file to mount'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'--mount /dev/dvd|image.iso'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:type</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'t'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'mount DVD-Video'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'--type data|video'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mount</span>(dir)
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    cmd_opts = [<span style="font-style: italic;">'mount'</span>]
    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:type</span>] == <span style="font-style: italic;">'video'</span> || <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video_dvd_image?(options[<span style="font-weight: bold; text-decoration: underline;">:device</span>])
      cmd_opts &lt;&lt; [<span style="font-style: italic;">'-t'</span>, <span style="font-style: italic;">'iso9660'</span>, <span style="font-style: italic;">'-o'</span>, <span style="font-style: italic;">'loop'</span>]
    <span style="font-weight: bold;">end</span>
    cmd_opts &lt;&lt; options[<span style="font-weight: bold; text-decoration: underline;">:device</span>]
    cmd_opts &lt;&lt; dir

    <span style="font-weight: bold; text-decoration: underline;">Dir</span>.mkdir(dir) <span style="font-weight: bold;">if</span> !<span style="font-weight: bold; text-decoration: underline;">Dir</span>.exist?(dir) &amp;&amp; !options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>]
    commander.execute(<span style="font-style: italic;">"sudo </span><span style="font-weight: bold; font-style: italic;">#{cmd_opts.join(' ')}</span><span style="font-style: italic;">"</span>)
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'umount'</span>, <span style="font-style: italic;">'unmount dir'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:remove</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'r'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:boolean</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'remove dir after unmounting'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">umount</span>(dir)
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    cmd_opts = [<span style="font-style: italic;">'umount'</span>]
    cmd_opts &lt;&lt; dir

    commander.execute(<span style="font-style: italic;">"sudo </span><span style="font-weight: bold; font-style: italic;">#{cmd_opts.join(' ')}</span><span style="font-style: italic;">"</span>)

    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:remove</span>]
      <span style="font-weight: bold; text-decoration: underline;">FileUtils</span>.rmdir(dir)
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'mkiso'</span>, <span style="font-style: italic;">'make ISO image file.'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:type</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'t'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'DVD image type. Data or Video DVD.'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'--type data|video'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:volume</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'V'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Volume Label'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'o'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'ISO image file name.'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'--out movie.iso'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mkiso</span>(file)
    names = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(file, options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    mkisofs_opts = [<span style="font-style: italic;">'mkisofs'</span>]
    mkisofs_opts &lt;&lt; [<span style="font-style: italic;">"-V"</span>, <span style="font-style: italic;">"\"</span><span style="font-weight: bold; font-style: italic;">#{options[:volume]}</span><span style="font-style: italic;">\""</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:volume</span>]
    <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:type</span>] == <span style="font-style: italic;">"data"</span>
      mkisofs_opts &lt;&lt; [<span style="font-style: italic;">"-r"</span>, <span style="font-style: italic;">"-l"</span>, <span style="font-style: italic;">"-J"</span>]
    <span style="font-weight: bold;">elsif</span> options[<span style="font-weight: bold; text-decoration: underline;">:type</span>]
      mkisofs_opts &lt;&lt; <span style="font-style: italic;">"-dvd-video"</span>
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold;">exit</span> 1
    <span style="font-weight: bold;">end</span>
    mkisofs_opts &lt;&lt; [<span style="font-style: italic;">"-o"</span>, <span style="font-style: italic;">"\"</span><span style="font-weight: bold; font-style: italic;">#{names.out_file('.iso')}</span><span style="font-style: italic;">\""</span>]
    mkisofs_opts &lt;&lt; <span style="font-style: italic;">"\"</span><span style="font-weight: bold; font-style: italic;">#{file}</span><span style="font-style: italic;">\""</span>

    commander.execute(mkisofs_opts.join(<span style="font-style: italic;">" "</span>))
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">'dvdburn &lt;file&gt;'</span>, <span style="font-style: italic;">'Burn file to DVD.'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:iso</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'I'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:boolean</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Set this option if &lt;file&gt; is ISO 9660 compliant.'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:volume</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'V'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:default</span> =&gt; <span style="font-style: italic;">'DVD_VIDEO'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Volume Label'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:video</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'v'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:boolean</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Create DVD video image file to burn.'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:speed</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'s'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:default</span> =&gt; <span style="font-style: italic;">'4'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Burning Speed'</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">'n'</span>
  option <span style="font-weight: bold; text-decoration: underline;">:device</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">'d'</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">'Device file'</span>, <span style="font-weight: bold; text-decoration: underline;">:default</span> =&gt; <span style="font-style: italic;">'/dev/sr0'</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">dvdburn</span>(file)
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    cmd_opts = [<span style="font-style: italic;">'growisofs'</span>]
    cmd_opts &lt;&lt; <span style="font-style: italic;">'-dvd-compat'</span>
    cmd_opts &lt;&lt; <span style="font-style: italic;">'-speed=%s'</span> % options[<span style="font-weight: bold; text-decoration: underline;">:speed</span>]
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.iso9660?(file) || options[<span style="font-weight: bold; text-decoration: underline;">:iso</span>]
      cmd_opts &lt;&lt; <span style="font-style: italic;">'-Z %s=%s'</span> % [options[<span style="font-weight: bold; text-decoration: underline;">:device</span>], file]
    <span style="font-weight: bold;">else</span>
      cmd_opts &lt;&lt; <span style="font-style: italic;">'-Z %s'</span> % options[<span style="font-weight: bold; text-decoration: underline;">:device</span>]
      mkisofs_opts = []
      mkisofs_opts &lt;&lt; [<span style="font-style: italic;">'-V'</span>, <span style="font-style: italic;">"\"</span><span style="font-weight: bold; font-style: italic;">#{options[:volume]}</span><span style="font-style: italic;">\""</span>] <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:volume</span>]
      <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:video</span>]
        mkisofs_opts &lt;&lt; <span style="font-style: italic;">'-dvd-video'</span>
      <span style="font-weight: bold;">else</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Data-DVD</span>
        mkisofs_opts &lt;&lt; [<span style="font-style: italic;">'-r'</span>, <span style="font-style: italic;">'-l'</span>, <span style="font-style: italic;">'-R'</span>]
      <span style="font-weight: bold;">end</span>
      mkisofs_opts &lt;&lt; file
      cmd_opts &lt;&lt; mkisofs_opts
    <span style="font-weight: bold;">end</span>

    commander.execute(cmd_opts.join(<span style="font-style: italic;">' '</span>))
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"cdburn"</span>, <span style="font-style: italic;">"burn files to CD device"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"Root Directory for image file"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:volume</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"v"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"Volume ID"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:device</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"d"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"Device file"</span>, <span style="font-weight: bold; text-decoration: underline;">:default</span> =&gt; <span style="font-style: italic;">"/dev/sr0"</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cdburn</span>()
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    commander.execute(<span style="font-style: italic;">"mkisofs -V \"</span><span style="font-weight: bold; font-style: italic;">#{options[:volume]}</span><span style="font-style: italic;">\" -J -r </span><span style="font-weight: bold; font-style: italic;">#{options[:in]}</span><span style="font-style: italic;"> | cdrecord -v dev=</span><span style="font-weight: bold; font-style: italic;">#{options[:device]}</span><span style="font-style: italic;"> -waiti -"</span>)
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"screenshot"</span>, <span style="font-style: italic;">"take a screenshot of a video at a time"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:time</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"t"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"ex. 00:10:22.300"</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">screenshot</span>()
    equip = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(equip.in_file) <span style="font-weight: bold;">then</span>
      args = [<span style="font-style: italic;">'ffmpeg'</span>]
      args &lt;&lt; (<span style="font-style: italic;">'-ss %s'</span> % options[<span style="font-weight: bold; text-decoration: underline;">:time</span>]) <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:time</span>]
      args &lt;&lt; <span style="font-style: italic;">'-i %s'</span> % equip.in_file
      args &lt;&lt; <span style="font-style: italic;">'-vframes 1'</span>
      args &lt;&lt; <span style="font-style: italic;">'-q:v 2'</span>
      args &lt;&lt; equip.out_file(<span style="font-style: italic;">'.jpg'</span>)
      commander.execute(args.join(<span style="font-style: italic;">' '</span>))
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"clip"</span>, <span style="font-style: italic;">"clip a video with specific time span"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:time_begin</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"b"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"ex. 00:10:22.300"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:time_end</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"e"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">clip</span>()
    equip = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(equip.in_file) <span style="font-weight: bold;">then</span>
      <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:time_begin</span>] <span style="font-weight: bold;">or</span> options[<span style="font-weight: bold; text-decoration: underline;">:time_end</span>] <span style="font-weight: bold;">then</span>
        in_opts = []
        in_opts &lt;&lt; <span style="font-style: italic;">"-ss </span><span style="font-weight: bold; font-style: italic;">#{options[:time_begin]}</span><span style="font-style: italic;">"</span> <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:time_begin</span>]
        in_opts &lt;&lt; <span style="font-style: italic;">"-to </span><span style="font-weight: bold; font-style: italic;">#{options[:time_end]}</span><span style="font-style: italic;">"</span> <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:time_end</span>]
        out_opts = []
        out_opts &lt;&lt; <span style="font-style: italic;">"-vcodec copy"</span>
        out_opts &lt;&lt; <span style="font-style: italic;">"-acodec copy"</span>
        out_opts &lt;&lt; <span style="font-style: italic;">"-map_metadata 0"</span>
        commander.execute(<span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>.command([<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(equip.in_file, in_opts)],
                                         [<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(equip.out_file, out_opts)]))
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; text-decoration: underline;">STDERR</span>.puts <span style="font-style: italic;">"This Media Format is not supported on this function"</span>
      <span style="font-weight: bold;">exit</span> <span style="font-weight: bold; text-decoration: underline;">false</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"crop"</span>, <span style="font-style: italic;">"extract a specific rectangle of a image/video"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:width</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"w"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:numeric</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:height</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"h"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:numeric</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:xpos</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"x"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:numeric</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"x coordinate of an original image where cropped image of top-left corner overlaps"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:ypos</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"y"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:numeric</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">crop</span>()
    names = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    width = options[<span style="font-weight: bold; text-decoration: underline;">:width</span>]
    height = options[<span style="font-weight: bold; text-decoration: underline;">:height</span>]
    xpos = options[<span style="font-weight: bold; text-decoration: underline;">:xpos</span>] ? options[<span style="font-weight: bold; text-decoration: underline;">:xpos</span>] : 0
    ypos = options[<span style="font-weight: bold; text-decoration: underline;">:ypos</span>] ? options[<span style="font-weight: bold; text-decoration: underline;">:ypos</span>] : 0
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(names.in_file) <span style="font-weight: bold;">then</span>
      opt = <span style="font-style: italic;">'-crop %dx%d+%dx%d'</span> % [width, height, xpos, ypos]
      commander.execute(<span style="font-style: italic;">"convert </span><span style="font-weight: bold; font-style: italic;">#{opt}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{names.in_file}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{names.out_file}</span><span style="font-style: italic;">"</span>)
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(names.in_file) <span style="font-weight: bold;">then</span>
      args = [<span style="font-style: italic;">'ffmpeg'</span>]
      args &lt;&lt; <span style="font-style: italic;">'-i %s'</span> % names.in_file
      args &lt;&lt; <span style="font-style: italic;">'-vf crop=%d:%d:%d:%d'</span> % [width, height, xpos, ypos]
      args &lt;&lt; <span style="font-style: italic;">"-map_metadata 0"</span>
      args &lt;&lt; names.out_file
      commander.execute(args.join(<span style="font-style: italic;">' '</span>))
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; text-decoration: underline;">STDERR</span>.puts <span style="font-style: italic;">"This Media Format is not supported on this function"</span>
      <span style="font-weight: bold;">exit</span> <span style="font-weight: bold; text-decoration: underline;">false</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"trim"</span>, <span style="font-style: italic;">"trim a image/video with automated detection"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:threshold</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"t"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"threshold where trimming begin and end"</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">trim</span>()
    names = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(names.in_file) <span style="font-weight: bold;">then</span>
      commander.execute(<span style="font-style: italic;">"convert -trim </span><span style="font-weight: bold; font-style: italic;">#{names.in_file}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{names.out_file}</span><span style="font-style: italic;">"</span>)
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.audio?(names.in_file) <span style="font-weight: bold;">then</span>
      threshold = (options[<span style="font-weight: bold; text-decoration: underline;">:threshold</span>]) ? options[<span style="font-weight: bold; text-decoration: underline;">:threshold</span>] : <span style="font-style: italic;">"-40dB"</span>
      commander.execute(<span style="font-style: italic;">"ffmpeg -i </span><span style="font-weight: bold; font-style: italic;">#{names.in_file}</span><span style="font-style: italic;"> -af \"silenceremove=start_periods=1:start_duration=0:start_threshold=</span><span style="font-weight: bold; font-style: italic;">#{threshold}</span><span style="font-style: italic;">:detection=peak\" </span><span style="font-weight: bold; font-style: italic;">#{names.out_file}</span><span style="font-style: italic;">"</span>)
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"resize"</span>, <span style="font-style: italic;">"resize the image"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:width</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"w"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"e.g. 300"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"resized image width"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:height</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"h"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"e.g. 200"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"resized image height"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:operation</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"p"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>,
         <span style="font-weight: bold; text-decoration: underline;">:banner</span> =&gt; <span style="font-style: italic;">"enlarge|shrink"</span>,
         <span style="font-weight: bold; text-decoration: underline;">:desc</span> =&gt; <span style="font-style: italic;">"permitted operation for resizing"</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">resize</span>()
    names = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(names.in_file) <span style="font-weight: bold;">then</span>
      <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:width</span>] <span style="font-weight: bold;">and</span> options[<span style="font-weight: bold; text-decoration: underline;">:height</span>]
        out_opts = []
        out_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-vf scale=%s:%s,setsar=1:1"</span>, options[<span style="font-weight: bold; text-decoration: underline;">:width</span>], options[<span style="font-weight: bold; text-decoration: underline;">:height</span>])
        commander.execute(<span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>.command([<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(names.in_file, [])],
                                         [<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(names.out_file, out_opts)]))
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(names.in_file) <span style="font-weight: bold;">then</span>
      <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:width</span>] == <span style="font-weight: bold; text-decoration: underline;">nil</span> &amp;&amp; options[<span style="font-weight: bold; text-decoration: underline;">:height</span>] == <span style="font-weight: bold; text-decoration: underline;">nil</span>
      <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:operation</span>] == <span style="font-style: italic;">"enlarge"</span>
        op = <span style="font-style: italic;">"&lt;"</span>
      <span style="font-weight: bold;">elsif</span> options[<span style="font-weight: bold; text-decoration: underline;">:operation</span>] == <span style="font-style: italic;">"shrink"</span>
        op = <span style="font-style: italic;">"&gt;"</span>
      <span style="font-weight: bold;">else</span>
        op = <span style="font-style: italic;">""</span>
      <span style="font-weight: bold;">end</span>
      geometry = <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"%sx%s%s"</span>, options[<span style="font-weight: bold; text-decoration: underline;">:width</span>], options[<span style="font-weight: bold; text-decoration: underline;">:height</span>], op)
      commander.execute(<span style="font-style: italic;">"convert -resize </span><span style="font-weight: bold; font-style: italic;">#{geometry}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{names.in_file}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{names.out_file}</span><span style="font-style: italic;">"</span>)
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"concat"</span>, <span style="font-style: italic;">"concat multiple files"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:array</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">concat</span>()
    names = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>][0], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    srcs = options[<span style="font-weight: bold; text-decoration: underline;">:in</span>]
    output = names.out_file

    <span style="font-weight: bold;">if</span> srcs.all? { |src| <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(src) }
      src_list = <span style="font-style: italic;">""</span>
      src_file = <span style="font-weight: bold; text-decoration: underline;">Tempfile</span>.open()
      chap_file = <span style="font-weight: bold; text-decoration: underline;">Tempfile</span>.open()
      chap_file.write(<span style="font-style: italic;">"### Create Chapterfile ###\n"</span>)
      files_to_remove = []
      time_accumulated = <span style="font-weight: bold; text-decoration: underline;">Time</span>.new(0)
      srcs.each_with_index <span style="font-weight: bold;">do</span> |src, index|
        valid_src =
          <span style="font-weight: bold;">if</span> src =~ <span style="font-style: italic;">/^\p{Ascii}+$/</span>
            src
          <span style="font-weight: bold;">else</span>
            <span style="font-weight: bold; text-decoration: underline;">Dir</span>::<span style="font-weight: bold; text-decoration: underline;">Tmpname</span>.create(<span style="font-style: italic;">'base'</span>) <span style="font-weight: bold;">do</span> |src_dup|
              <span style="font-weight: bold; text-decoration: underline;">FileUtils</span>.cp(src, src_dup)
              files_to_remove &lt;&lt; src_dup
              src_dup
            <span style="font-weight: bold;">end</span>
          <span style="font-weight: bold;">end</span>
        src_file.write(<span style="font-style: italic;">"file '</span><span style="font-weight: bold; font-style: italic;">#{File.expand_path(valid_src)}</span><span style="font-style: italic;">'\n"</span>)
        chap_file.write(<span style="font-style: italic;">"CHAPTER</span><span style="font-weight: bold; font-style: italic;">#{index + 1}</span><span style="font-style: italic;">=</span><span style="font-weight: bold; font-style: italic;">#{time_accumulated.strftime('%H:%M:%S.%L')}</span><span style="font-style: italic;">\n"</span>)
        chap_file.write(<span style="font-style: italic;">"CHAPTER</span><span style="font-weight: bold; font-style: italic;">#{index + 1}</span><span style="font-style: italic;">NAME=</span><span style="font-weight: bold; font-style: italic;">#{File.basename(src, File.extname(src))}</span><span style="font-style: italic;">\n"</span>)
        duration = <span style="font-style: italic;">`ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "</span><span style="font-weight: bold; font-style: italic;">#{src}</span><span style="font-style: italic;">"`</span>.strip().to_f()
        time_accumulated += duration
      <span style="font-weight: bold;">end</span>
      src_file.flush
      commander.execute(<span style="font-style: italic;">"ffmpeg -n -f concat -safe 0 -i </span><span style="font-weight: bold; font-style: italic;">#{src_file.path}</span><span style="font-style: italic;"> -c:v copy -c:a copy -c:s copy -map 0:v -map 0:a -map 0:s? </span><span style="font-weight: bold; font-style: italic;">#{output}</span><span style="font-style: italic;">"</span>)
      src_file.close
      chap_file.flush
      commander.execute(<span style="font-style: italic;">"MP4Box -chap </span><span style="font-weight: bold; font-style: italic;">#{chap_file.path}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{output}</span><span style="font-style: italic;">"</span>)
      chap_file.close
      src_file.unlink
      chap_file.unlink
      <span style="font-weight: bold; text-decoration: underline;">FileUtils</span>.rm_f(files_to_remove)
    <span style="font-weight: bold;">elsif</span> srcs.all? { |src| <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(src) }
      commander.execute <span style="font-style: italic;">"convert </span><span style="font-weight: bold; font-style: italic;">#{srcs.join(' ')}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{output}</span><span style="font-style: italic;">"</span>
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; text-decoration: underline;">STDERR</span>.puts <span style="font-style: italic;">"This Media Format is not supported on this function"</span>
      <span style="font-weight: bold;">exit</span> <span style="font-weight: bold; text-decoration: underline;">false</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"diff"</span>, <span style="font-style: italic;">"measure the difference by providing SSIM value"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">diff</span>(file1, file2)
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    <span style="font-weight: bold;">if</span> ((<span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(file1) <span style="font-weight: bold;">and</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.video?(file2)) <span style="font-weight: bold;">or</span>
        (<span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(file1) <span style="font-weight: bold;">and</span> <span style="font-weight: bold; text-decoration: underline;">FileType</span>.image?(file2))) <span style="font-weight: bold;">then</span>
      <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:out</span>] <span style="font-weight: bold;">then</span>
        commander.execute(<span style="font-style: italic;">"ffmpeg -i </span><span style="font-weight: bold; font-style: italic;">#{file1}</span><span style="font-style: italic;"> -i </span><span style="font-weight: bold; font-style: italic;">#{file2}</span><span style="font-style: italic;"> -filter_complex ssim=</span><span style="font-weight: bold; font-style: italic;">#{options[:out]}</span><span style="font-style: italic;"> -an -f null -"</span>)
      <span style="font-weight: bold;">else</span>
        commander.execute(<span style="font-style: italic;">"ffmpeg -i </span><span style="font-weight: bold; font-style: italic;">#{file1}</span><span style="font-style: italic;"> -i </span><span style="font-weight: bold; font-style: italic;">#{file2}</span><span style="font-style: italic;"> -filter_complex ssim -an -f null -"</span>)
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"mux"</span>, <span style="font-style: italic;">"mux to one file which has streams correspond with input files"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:video</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"v"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:audio</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"a"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:audio_delay</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"d"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mux</span>()
    names = <span style="font-weight: bold; text-decoration: underline;">Names</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:video</span>], options[<span style="font-weight: bold; text-decoration: underline;">:out</span>])
    commander = <span style="font-weight: bold; text-decoration: underline;">Commander</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:log</span>], options[<span style="font-weight: bold; text-decoration: underline;">:dryrun</span>])

    in_optsets = []
    in_optsets &lt;&lt; <span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:video</span>], [])
    aconf = []
    aconf &lt;&lt; <span style="font-style: italic;">"-itsoffset </span><span style="font-weight: bold; font-style: italic;">#{options[:audio_delay]}</span><span style="font-style: italic;">"</span> <span style="font-weight: bold;">if</span> options[<span style="font-weight: bold; text-decoration: underline;">:audio_delay</span>]
    in_optsets &lt;&lt; <span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(options[<span style="font-weight: bold; text-decoration: underline;">:audio</span>], aconf)
    commander.execute(<span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>.command(in_optsets,
                                     [<span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span>.new(names.out_file, [])]))
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MainConfig</span>
  <span style="font-weight: bold;">attr_accessor</span> <span style="font-weight: bold; text-decoration: underline;">:start</span>, <span style="font-weight: bold; text-decoration: underline;">:end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">VideoConfig</span>
  <span style="font-weight: bold;">attr_accessor</span> <span style="font-weight: bold; text-decoration: underline;">:encode</span>, <span style="font-weight: bold; text-decoration: underline;">:quality</span>, <span style="font-weight: bold; text-decoration: underline;">:bitrate</span>, <span style="font-weight: bold; text-decoration: underline;">:preset</span>, <span style="font-weight: bold; text-decoration: underline;">:tune</span>, <span style="font-weight: bold; text-decoration: underline;">:profile</span>, <span style="font-weight: bold; text-decoration: underline;">:level</span>

  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_ENCODE</span> = <span style="font-style: italic;">'vp9'</span>
  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_QUALITY</span> = <span style="font-style: italic;">'26'</span>
  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_BITRATE</span> = <span style="font-style: italic;">'1000'</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">initialize</span>(encode, quality=<span style="font-weight: bold; text-decoration: underline;">nil</span>, bitrate=<span style="font-weight: bold; text-decoration: underline;">nil</span>)
    <span style="font-weight: bold; font-style: italic;">@encode</span> = encode
    <span style="font-weight: bold; font-style: italic;">@quality</span> = quality
    <span style="font-weight: bold; font-style: italic;">@bitrate</span> = bitrate

    <span style="font-weight: bold;">case</span> <span style="font-weight: bold; font-style: italic;">@encode</span>
    <span style="font-weight: bold;">when</span> <span style="font-style: italic;">"x265"</span>
      <span style="font-weight: bold; font-style: italic;">@preset</span> = <span style="font-style: italic;">"veryslow"</span>
      <span style="font-weight: bold; font-style: italic;">@tune</span> = <span style="font-style: italic;">"ssim"</span>
      <span style="font-weight: bold; font-style: italic;">@profile</span> = <span style="font-style: italic;">"main"</span>
      <span style="font-weight: bold; font-style: italic;">@level</span> = <span style="font-weight: bold; text-decoration: underline;">nil</span>
    <span style="font-weight: bold;">when</span> <span style="font-style: italic;">"x264"</span>
      <span style="font-weight: bold; font-style: italic;">@preset</span> = <span style="font-style: italic;">"veryslow"</span>
      <span style="font-weight: bold; font-style: italic;">@tune</span> = <span style="font-style: italic;">"film"</span>
      <span style="font-weight: bold; font-style: italic;">@profile</span> = <span style="font-style: italic;">"main"</span>
      <span style="font-weight: bold; font-style: italic;">@level</span> = <span style="font-style: italic;">"4.1"</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PictureConfig</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">conversion options</span>
  <span style="font-weight: bold;">attr_accessor</span> <span style="font-weight: bold; text-decoration: underline;">:vf_opts</span>, <span style="font-weight: bold; text-decoration: underline;">:fps</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">initialize</span>()
    <span style="font-weight: bold; font-style: italic;">@vf_opts</span> = []
    <span style="font-weight: bold; font-style: italic;">@vf_opts</span> &lt;&lt; <span style="font-style: italic;">"format=yuv420p"</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">down-size to fit to display (width:heigh) in keeping aspect ratio</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fit_size</span>(display_size)
    <span style="font-weight: bold; font-style: italic;">@vf_opts</span> &lt;&lt; <span style="font-style: italic;">"scale=</span><span style="font-weight: bold; font-style: italic;">#{display_size}</span><span style="font-style: italic;">:force_original_aspect_ratio=decrease"</span>
    <span style="font-weight: bold; font-style: italic;">@vf_opts</span> &lt;&lt; <span style="font-style: italic;">"pad=((iw+1)/2)*2:((ih+1)/2)*2"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">avoid width/height to odd</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">decrease_framerate</span>(fps)
    <span style="font-weight: bold; font-style: italic;">@fps</span> = fps
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AudioConfig</span>
  <span style="font-weight: bold;">attr_accessor</span> <span style="font-weight: bold; text-decoration: underline;">:encode</span>, <span style="font-weight: bold; text-decoration: underline;">:quality</span>, <span style="font-weight: bold; text-decoration: underline;">:bitrate</span>

  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_ENCODE</span> = <span style="font-style: italic;">'opus'</span>
  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_QUALITY</span> = <span style="font-style: italic;">'100'</span>
  <span style="font-weight: bold; text-decoration: underline;">DEFAULT_BITRATE</span> = <span style="font-style: italic;">'128'</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">initialize</span>(encode, quality=<span style="font-weight: bold; text-decoration: underline;">nil</span>, bitrate=<span style="font-weight: bold; text-decoration: underline;">nil</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">@encode = (encode ? encode : DEFAULT_ENCODE)</span>
    <span style="font-weight: bold; font-style: italic;">@encode</span> = encode
    <span style="font-weight: bold; font-style: italic;">@quality</span> = quality
    <span style="font-weight: bold; font-style: italic;">@bitrate</span> = bitrate
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">quality</span>
    <span style="font-weight: bold;">case</span> <span style="font-weight: bold; font-style: italic;">@encode</span>
    <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'opus'</span>
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; font-style: italic;">@quality</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">bitrate</span>
    <span style="font-weight: bold;">case</span> <span style="font-weight: bold; font-style: italic;">@encode</span>
    <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'opus'</span>
      (<span style="font-weight: bold; font-style: italic;">@bitrate</span> ? <span style="font-weight: bold; font-style: italic;">@bitrate</span> : <span style="font-weight: bold; text-decoration: underline;">DEFAULT_BITRATE</span>)
    <span style="font-weight: bold;">else</span>
      <span style="font-weight: bold; font-style: italic;">@bitrate</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DVDConfig</span>
  <span style="font-weight: bold;">attr_accessor</span> <span style="font-weight: bold; text-decoration: underline;">:title</span>, <span style="font-weight: bold; text-decoration: underline;">:chapters</span>, <span style="font-weight: bold; text-decoration: underline;">:audio</span>, <span style="font-weight: bold; text-decoration: underline;">:subtitle</span>, <span style="font-weight: bold; text-decoration: underline;">:options</span>
  <span style="font-weight: bold;">attr_accessor</span> <span style="font-weight: bold; text-decoration: underline;">:chapter_marker</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">initialize</span>
    <span style="font-weight: bold; font-style: italic;">@chapter_marker</span> = <span style="font-weight: bold; text-decoration: underline;">true</span>
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ImageConfig</span>
  <span style="font-weight: bold;">attr_reader</span> <span style="font-weight: bold; text-decoration: underline;">:quality</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">1~100</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">FFMPEGOptSet</span> &lt; <span style="font-weight: bold; text-decoration: underline;">Struct</span>.new(<span style="font-weight: bold; text-decoration: underline;">:fname</span>, <span style="font-weight: bold; text-decoration: underline;">:optset</span>)
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">command</span>(in_optsets, out_optsets)
    opts = [<span style="font-style: italic;">"ffmpeg"</span>]

    infilep = <span style="font-weight: bold;">proc</span> <span style="font-weight: bold;">do</span> |fname, optset|
      opt_arr = []
      optset.each <span style="font-weight: bold;">do</span> |opt|
        <span style="font-weight: bold;">if</span> opt.instance_of?(<span style="font-weight: bold; text-decoration: underline;">String</span>)
          opt_arr &lt;&lt; opt
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">end</span>
      opt_arr &lt;&lt; [<span style="font-style: italic;">"-i"</span>, <span style="font-style: italic;">"\"</span><span style="font-weight: bold; font-style: italic;">#{fname}</span><span style="font-style: italic;">\""</span>]
      <span style="font-weight: bold;">next</span> opt_arr
    <span style="font-weight: bold;">end</span>
    in_optsets.each <span style="font-weight: bold;">do</span> |in_optset|
      opts &lt;&lt; infilep.call(in_optset.fname, in_optset.optset)
    <span style="font-weight: bold;">end</span>

    outfilep = <span style="font-weight: bold;">proc</span> <span style="font-weight: bold;">do</span> |fname, optset|
      oopts = []
      optset.each <span style="font-weight: bold;">do</span> |opt|
        <span style="font-weight: bold;">if</span> opt.instance_of?(<span style="font-weight: bold; text-decoration: underline;">VideoConfig</span>)
          <span style="font-weight: bold;">case</span> opt.encode
          <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'av1'</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:v librav1e"</span>)
            <span style="font-weight: bold;">if</span> opt.bitrate
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-b:v %sk"</span>, opt.bitrate)
            <span style="font-weight: bold;">end</span>
          <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'vp9'</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:v libvpx-vp9"</span>)
            <span style="font-weight: bold;">if</span> opt.quality
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-crf %s"</span>, opt.quality)
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-b:v 0"</span>)
            <span style="font-weight: bold;">elsif</span> opt.bitrate
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-b:v %s"</span>, opt.bitrate)
            <span style="font-weight: bold;">end</span>
          <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'h265'</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:v libx265"</span>)
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-crf %s"</span>, opt.quality)
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-preset %s"</span>, opt.preset) <span style="font-weight: bold;">if</span> opt.preset
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-tune %s"</span>, opt.tune) <span style="font-weight: bold;">if</span> opt.tune
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Currently, ffmpeg &#8203;does not support setting profiles on x265</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-profile:v %s"</span>, opt.profile) <span style="font-weight: bold;">if</span> opt.profile &amp;&amp; opt.encoder == <span style="font-style: italic;">'x264'</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-level %s"</span>, opt.level) <span style="font-weight: bold;">if</span> opt.level
          <span style="font-weight: bold;">else</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:v copy"</span>)
          <span style="font-weight: bold;">end</span>
        <span style="font-weight: bold;">elsif</span> opt.instance_of?(<span style="font-weight: bold; text-decoration: underline;">AudioConfig</span>)
          <span style="font-weight: bold;">case</span> opt.encode
          <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'opus'</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:a lib%s"</span>, opt.encode)
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-b:a %sk"</span>, opt.bitrate) <span style="font-weight: bold;">if</span> opt.bitrate
          <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'aac'</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:a libfdk_aac"</span>)
            <span style="font-weight: bold;">if</span> opt.quality
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-aq %s"</span>, opt.quality)
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-b:a 0"</span>)
            <span style="font-weight: bold;">elsif</span> opt.bitrate
              oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-b:a %s"</span>, opt.bitrate)
            <span style="font-weight: bold;">end</span>
          <span style="font-weight: bold;">else</span>
            oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-c:a copy"</span>)
          <span style="font-weight: bold;">end</span>
        <span style="font-weight: bold;">elsif</span> opt.instance_of?(<span style="font-weight: bold; text-decoration: underline;">PictureConfig</span>)
          oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-vf \"%s\""</span>, opt.vf_opts.join(<span style="font-style: italic;">","</span>)) <span style="font-weight: bold;">if</span> opt.vf_opts &amp;&amp; opt.vf_opts.any?
          oopts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"-r %s"</span>, opt.fps) <span style="font-weight: bold;">if</span> opt.fps
        <span style="font-weight: bold;">elsif</span> opt.instance_of?(<span style="font-weight: bold; text-decoration: underline;">String</span>)
          oopts &lt;&lt; opt
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">end</span>
      oopts &lt;&lt; <span style="font-style: italic;">"\"</span><span style="font-weight: bold; font-style: italic;">#{fname}</span><span style="font-style: italic;">\""</span>
      <span style="font-weight: bold;">next</span> oopts
    <span style="font-weight: bold;">end</span>
    out_optsets.each <span style="font-weight: bold;">do</span> |out_optset|
      opts &lt;&lt; outfilep.call(out_optset.fname, out_optset.optset)
    <span style="font-weight: bold;">end</span>

    opts.join(<span style="font-style: italic;">" "</span>)
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">HandBrakeCLI</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">command</span>(input, output, configs, raw_option)
    cmd_opts = [<span style="font-style: italic;">"HandBrakeCLI"</span>]
    cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--input \"%s\""</span>, input)
    cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--output \"%s\""</span>, output)
    configs.each <span style="font-weight: bold;">do</span> |config|
      <span style="font-weight: bold;">if</span> config.instance_of?(<span style="font-weight: bold; text-decoration: underline;">VideoConfig</span>)
        <span style="font-weight: bold;">case</span> config.encode
        <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'vp9'</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder VP9"</span>)
          <span style="font-weight: bold;">if</span> config.quality
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--quality %s"</span>, config.quality)
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--vb 0"</span>)
          <span style="font-weight: bold;">elsif</span> config.bitrate
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--vb %s"</span>, config.bitrate)
          <span style="font-weight: bold;">end</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder-preset veryslow"</span>)
        <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'h265'</span> || <span style="font-style: italic;">'hevc'</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder x265"</span>)
          <span style="font-weight: bold;">if</span> config.quality
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--quality %s"</span>, config.quality)
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--vb 0"</span>)
          <span style="font-weight: bold;">elsif</span> config.bitrate
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--vb %s"</span>, config.bitrate)
          <span style="font-weight: bold;">end</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder-preset %s"</span>, config.preset) <span style="font-weight: bold;">if</span> config.preset
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder-tune %s"</span>, config.tune) <span style="font-weight: bold;">if</span> config.tune
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder-profile %s"</span>, config.profile) <span style="font-weight: bold;">if</span> config.profile
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder-level %s"</span>, config.level) <span style="font-weight: bold;">if</span> config.level
        <span style="font-weight: bold;">else</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--encoder %s"</span>, config.encode) <span style="font-weight: bold;">if</span> config.encode
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--quality %s"</span>, config.quality) <span style="font-weight: bold;">if</span> config.quality
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--vb %s"</span>, config.bitrate) <span style="font-weight: bold;">if</span> config.bitrate
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">elsif</span> config.instance_of?(<span style="font-weight: bold; text-decoration: underline;">AudioConfig</span>)
        <span style="font-weight: bold;">case</span> config.encode
        <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'opus'</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--aencoder %s"</span>, config.encode)
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--aq %s"</span>, config.quality) <span style="font-weight: bold;">if</span> config.quality
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--ab %s"</span>, config.bitrate) <span style="font-weight: bold;">if</span> config.bitrate
        <span style="font-weight: bold;">when</span> <span style="font-style: italic;">'aac'</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--aencoder ca_haac"</span>)
          <span style="font-weight: bold;">if</span> config.quality
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--aq %s"</span>, config.quality)
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--ab 0"</span>)
          <span style="font-weight: bold;">elsif</span> config.bitrate
            cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--ab %s"</span>, config.bitrate)
          <span style="font-weight: bold;">end</span>
        <span style="font-weight: bold;">else</span>
          cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--aencoder copy"</span>)
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">elsif</span> config.instance_of?(<span style="font-weight: bold; text-decoration: underline;">DVDConfig</span>)
        cmd_opts &lt;&lt; (config.title ? <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--title %s"</span>, config.title) : <span style="font-style: italic;">"--main-feature"</span>)
        cmd_opts &lt;&lt; <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--chapters %s"</span>, config.chapters) <span style="font-weight: bold;">if</span> config.chapters
        cmd_opts &lt;&lt; <span style="font-style: italic;">"--markers"</span> <span style="font-weight: bold;">if</span> config.chapter_marker
        cmd_opts &lt;&lt; (config.audio ? <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--audio %s"</span>, config.audio) : <span style="font-style: italic;">"--all-audio"</span> )
        cmd_opts &lt;&lt; (config.subtitle ? <span style="font-weight: bold;">format</span>(<span style="font-style: italic;">"--subtitle %s"</span>, config.subtitle) : <span style="font-style: italic;">"--all-subtitles"</span> )
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>

    cmd_opts &lt;&lt; raw_option <span style="font-weight: bold;">if</span> raw_option

    cmd_opts.join(<span style="font-style: italic;">" "</span>)
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ImageMagick</span>
  <span style="font-weight: bold; text-decoration: underline;">COMMAND</span> = <span style="font-style: italic;">"convert %s %s %s %s "</span>

  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">self</span>.<span style="font-weight: bold;">command</span>(input, output, pconfig, raw_option=<span style="font-style: italic;">""</span>)
    input_opt = <span style="font-style: italic;">""</span>
    output_opt = <span style="font-style: italic;">""</span>
    <span style="font-weight: bold;">if</span> pconfig.instance_of?(<span style="font-weight: bold; text-decoration: underline;">ImageConfig</span>) <span style="font-weight: bold;">then</span>
      input_opt += <span style="font-style: italic;">"-quality %s"</span> % pconfig.quality <span style="font-weight: bold;">if</span> pconfig.quality
      s = <span style="font-weight: bold; text-decoration: underline;">COMMAND</span> % [input, input_opt, output, output_opt]
      s
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold; text-decoration: underline;">MediaUtil</span>.start(<span style="font-weight: bold; text-decoration: underline;">ARGV</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org9996d96" class="outline-2">
<h2 id="org9996d96">genalbum</h2>
<div class="outline-text-2" id="text-org9996d96">
<p>
Personal script for encoding family pictures and movies.
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env ruby</span>

<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'fileutils'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'time'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'exifr'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'streamio-ffmpeg'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'pathname'</span>
<span style="font-weight: bold;">require</span> <span style="font-style: italic;">'thor'</span>

<span style="font-weight: bold; text-decoration: underline;">PICTURE_FILE_EXTS</span> = [<span style="font-style: italic;">".jpg"</span>]
<span style="font-weight: bold; text-decoration: underline;">MOVIE_FILE_EXTS</span> = [<span style="font-style: italic;">".mp4"</span>]
<span style="font-weight: bold; text-decoration: underline;">ALBUM_DIR_NAME</span> = <span style="font-style: italic;">"album/"</span>
<span style="font-weight: bold; text-decoration: underline;">RENAME_DIR_NAME</span> = <span style="font-style: italic;">"rename/"</span>
<span style="font-weight: bold; text-decoration: underline;">WEB_DIR_NAME</span> = <span style="font-style: italic;">"album_web/"</span>
<span style="font-weight: bold; text-decoration: underline;">IMG_PREFIX</span> = <span style="font-style: italic;">"img_"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">GenAlbum</span> &lt; <span style="font-weight: bold; text-decoration: underline;">Thor</span>
  default_command <span style="font-weight: bold; text-decoration: underline;">:album</span>
  desc <span style="font-style: italic;">"[album] -i &lt;img_dir&gt;"</span>, <span style="font-style: italic;">"generate album"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">album</span>
    src_path = <span style="font-weight: bold; text-decoration: underline;">File</span>.expand_path(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], <span style="font-weight: bold; text-decoration: underline;">Dir</span>.pwd)
    dest_path = <span style="font-weight: bold; text-decoration: underline;">ALBUM_DIR_NAME</span>

    <span style="font-weight: bold; text-decoration: underline;">FileUtils</span>.mkdir_p(dest_path) <span style="font-weight: bold;">unless</span> <span style="font-weight: bold; text-decoration: underline;">FileTest</span>.exist?(dest_path)

    <span style="font-weight: bold; text-decoration: underline;">Dir</span>.glob(src_path + <span style="font-style: italic;">"/*"</span>).each <span style="font-weight: bold;">do</span> |img_file|
      basename = <span style="font-weight: bold; text-decoration: underline;">File</span>::basename(img_file)
      src_file = src_path + <span style="font-style: italic;">"/"</span> + basename
      dest_file = dest_path + <span style="font-style: italic;">"/"</span> + basename
      ext = <span style="font-weight: bold; text-decoration: underline;">File</span>.extname(img_file)
      <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">PICTURE_FILE_EXTS</span>.index(ext.downcase) != <span style="font-weight: bold; text-decoration: underline;">nil</span> <span style="font-weight: bold;">then</span>
        <span style="font-weight: bold;">system</span>(<span style="font-style: italic;">"convert -resize \"4096x&gt;\" -quality 92 </span><span style="font-weight: bold; font-style: italic;">#{src_file}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{dest_file}</span><span style="font-style: italic;">"</span>)
      <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">MOVIE_FILE_EXTS</span>.index(ext.downcase) != <span style="font-weight: bold; text-decoration: underline;">nil</span> <span style="font-weight: bold;">then</span>
        <span style="font-weight: bold;">system</span>(<span style="font-style: italic;">"mediautil encode -i </span><span style="font-weight: bold; font-style: italic;">#{src_file}</span><span style="font-style: italic;"> -o </span><span style="font-weight: bold; font-style: italic;">#{dest_file}</span><span style="font-style: italic;"> -q 22.0 -Q 100.0"</span>)
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"web -i &lt;img_dir&gt;"</span>, <span style="font-style: italic;">"generate lightweight album for web"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">web</span>
    src_path = <span style="font-weight: bold; text-decoration: underline;">File</span>.expand_path(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], <span style="font-weight: bold; text-decoration: underline;">Dir</span>.pwd)
    dest_path = <span style="font-weight: bold; text-decoration: underline;">WEB_DIR_NAME</span>

    <span style="font-weight: bold; text-decoration: underline;">FileUtils</span>.mkdir_p(dest_path) <span style="font-weight: bold;">unless</span> <span style="font-weight: bold; text-decoration: underline;">FileTest</span>.exist?(dest_path)

    <span style="font-weight: bold; text-decoration: underline;">Dir</span>.glob(src_path + <span style="font-style: italic;">"/*"</span>).each <span style="font-weight: bold;">do</span> |img_file|
      basename = <span style="font-weight: bold; text-decoration: underline;">File</span>::basename(img_file)
      src_file = src_path + <span style="font-style: italic;">"/"</span> + basename
      dest_file = dest_path + <span style="font-style: italic;">"/"</span> + basename
      ext = <span style="font-weight: bold; text-decoration: underline;">File</span>.extname(img_file)
      <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">PICTURE_FILE_EXTS</span>.index(ext.downcase) != <span style="font-weight: bold; text-decoration: underline;">nil</span> <span style="font-weight: bold;">then</span>
        <span style="font-weight: bold;">system</span>(<span style="font-style: italic;">"convert -resize \"1024x&gt;\" -quality 80 </span><span style="font-weight: bold; font-style: italic;">#{src_file}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{dest_file}</span><span style="font-style: italic;">"</span>)
      <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">MOVIE_FILE_EXTS</span>.index(ext.downcase) != <span style="font-weight: bold; text-decoration: underline;">nil</span> <span style="font-weight: bold;">then</span>
        <span style="font-weight: bold;">system</span>(<span style="font-style: italic;">"mediautil encode -i </span><span style="font-weight: bold; font-style: italic;">#{src_file}</span><span style="font-style: italic;"> -o </span><span style="font-weight: bold; font-style: italic;">#{dest_file}</span><span style="font-style: italic;"> -q 26.0 -Q 100.0"</span>)
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>

  desc <span style="font-style: italic;">"renmae -i &lt;img_dir&gt;"</span>, <span style="font-style: italic;">"rename image files in chlonological order"</span>
  option <span style="font-weight: bold; text-decoration: underline;">:in</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"i"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>, <span style="font-weight: bold; text-decoration: underline;">:required</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">true</span>
  option <span style="font-weight: bold; text-decoration: underline;">:out</span>, <span style="font-weight: bold; text-decoration: underline;">aliases:</span> <span style="font-style: italic;">"o"</span>, <span style="font-weight: bold; text-decoration: underline;">:type</span> =&gt; <span style="font-weight: bold; text-decoration: underline;">:string</span>
  <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">rename</span>
    src_path = <span style="font-weight: bold; text-decoration: underline;">File</span>.expand_path(options[<span style="font-weight: bold; text-decoration: underline;">:in</span>], <span style="font-weight: bold; text-decoration: underline;">Dir</span>.pwd)
    dest_path = ((options[<span style="font-weight: bold; text-decoration: underline;">:out</span>]) ? options[<span style="font-weight: bold; text-decoration: underline;">:out</span>] : <span style="font-weight: bold; text-decoration: underline;">RENAME_DIR_NAME</span>)

    <span style="font-weight: bold; text-decoration: underline;">FileUtils</span>.mkdir_p(dest_path) <span style="font-weight: bold;">unless</span> <span style="font-weight: bold; text-decoration: underline;">FileTest</span>.exist?(dest_path)

    img_time = {}
    <span style="font-weight: bold; text-decoration: underline;">Dir</span>.glob(src_path + <span style="font-style: italic;">"/*"</span>).each <span style="font-weight: bold;">do</span> |img_file|
      ext = <span style="font-weight: bold; text-decoration: underline;">File</span>.extname(img_file)
      <span style="font-weight: bold;">if</span> <span style="font-weight: bold; text-decoration: underline;">PICTURE_FILE_EXTS</span>.index(ext.downcase) != <span style="font-weight: bold; text-decoration: underline;">nil</span> <span style="font-weight: bold;">then</span>
        pic = <span style="font-weight: bold; text-decoration: underline;">EXIFR</span>::<span style="font-weight: bold; text-decoration: underline;">JPEG</span>.new(img_file)
        <span style="font-weight: bold;">if</span> pic.exif? &amp;&amp; pic.date_time_original <span style="font-weight: bold;">then</span>
          img_time[img_file] = pic.date_time_original
        <span style="font-weight: bold;">else</span>
          img_time[img_file] = <span style="font-weight: bold; text-decoration: underline;">Time</span>.now
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">elsif</span> <span style="font-weight: bold; text-decoration: underline;">MOVIE_FILE_EXTS</span>.index(ext.downcase) != <span style="font-weight: bold; text-decoration: underline;">nil</span> <span style="font-weight: bold;">then</span>
        movie = <span style="font-weight: bold; text-decoration: underline;">FFMPEG</span>::<span style="font-weight: bold; text-decoration: underline;">Movie</span>.new(img_file)
        time = movie.creation_time
        <span style="font-weight: bold;">if</span> time <span style="font-weight: bold;">then</span>
          img_time[img_file] = time
        <span style="font-weight: bold;">else</span>
          img_time[img_file] = <span style="font-weight: bold; text-decoration: underline;">Time</span>.now
        <span style="font-weight: bold;">end</span>
      <span style="font-weight: bold;">end</span>
    <span style="font-weight: bold;">end</span>
    img_time = img_time.sort_by{ |_, v| v }

    digit = img_time.length.to_s.length
    digit = 2 <span style="font-weight: bold;">if</span> digit &lt; 2
    img_time.each_with_index <span style="font-weight: bold;">do</span> |(img, time), i|
      ext = <span style="font-weight: bold; text-decoration: underline;">File</span>.extname(img).downcase
      base = <span style="font-weight: bold; text-decoration: underline;">IMG_PREFIX</span> + <span style="font-style: italic;">"%0</span><span style="font-weight: bold; font-style: italic;">#{digit}</span><span style="font-style: italic;">d"</span> % (i + 1) + ext
      src_file = img
      dest_file = dest_path + <span style="font-style: italic;">"/"</span> + base
      <span style="font-weight: bold;">system</span>(<span style="font-style: italic;">"cp </span><span style="font-weight: bold; font-style: italic;">#{src_file}</span><span style="font-style: italic;"> </span><span style="font-weight: bold; font-style: italic;">#{dest_file}</span><span style="font-style: italic;">"</span>)
    <span style="font-weight: bold;">end</span>
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>

<span style="font-weight: bold; text-decoration: underline;">GenAlbum</span>.start(<span style="font-weight: bold; text-decoration: underline;">ARGV</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd76e9f1" class="outline-2">
<h2 id="orgd76e9f1">nhp</h2>
<div class="outline-text-2" id="text-orgd76e9f1">
<p>
Exec command in background
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold;">readonly</span> <span style="font-weight: bold; font-style: italic;">MAIL_FROM</span>=<span style="font-style: italic;">"&lt;&lt;email()&gt;&gt;"</span>
<span style="font-weight: bold;">readonly</span> <span style="font-weight: bold; font-style: italic;">MAIL_TO</span>=<span style="font-style: italic;">"&lt;&lt;email()&gt;&gt;"</span>

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">usage</span>() {
  cat &lt;&lt;_EOT_
<span style="font-weight: bold;">Usage:</span>
<span style="font-weight: bold;">  $(basename "$0") [options] command|exefile</span>

<span style="font-weight: bold;">Description:</span>
<span style="font-weight: bold;">  $(basename "$0") executes command(s) in back-ground process continueing after the user logs out</span>

<span style="font-weight: bold;">Options:</span>
<span style="font-weight: bold;">  -l &lt;logfile&gt;  log file name</span>
<span style="font-weight: bold;">  -p &lt;pidfile&gt;  process id file name</span>
<span style="font-weight: bold;">  -h            help</span>

<span style="font-weight: bold;">_EOT_</span>
  <span style="font-weight: bold;">exit</span> 1
}

<span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"${OPTIND}"</span> = 1 ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">while </span><span style="font-weight: bold;">getopts</span> l:p:h OPT
  <span style="font-weight: bold;">do</span>
    <span style="font-weight: bold;">case</span> ${<span style="font-weight: bold; font-style: italic;">OPT</span>} <span style="font-weight: bold;">in</span>
    l)
      <span style="font-weight: bold; font-style: italic;">opt_logfile</span>=${<span style="font-weight: bold; font-style: italic;">OPTARG</span>}
      ;;
    p)
      <span style="font-weight: bold; font-style: italic;">opt_pidfile</span>=${<span style="font-weight: bold; font-style: italic;">OPTARG</span>}
      ;;
    h)
      usage
      ;;
    <span style="font-style: italic;">\?</span>)
      <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Try to enter the h option."</span> 1&gt;&amp;2
      ;;
    <span style="font-weight: bold;">esac</span>
  <span style="font-weight: bold;">done</span>
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"No installed getopts-command."</span> 1&gt;&amp;2
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">shift</span> $((OPTIND - 1))

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">mailtome</span>() {
  local <span style="font-weight: bold; font-style: italic;">_command</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
  local <span style="font-weight: bold; font-style: italic;">_whole_command</span>=$<span style="font-weight: bold; font-style: italic;">2</span>
  local <span style="font-weight: bold; font-style: italic;">_logfile_rel</span>=$<span style="font-weight: bold; font-style: italic;">4</span>

  <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$3"</span> -eq 0 ]; <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; font-style: italic;">_result</span>=<span style="font-style: italic;">'success'</span>
  <span style="font-weight: bold;">else</span>
    <span style="font-weight: bold; font-style: italic;">_result</span>=<span style="font-style: italic;">'failed'</span>
  <span style="font-weight: bold;">fi</span>
  <span style="font-weight: bold; font-style: italic;">_logfile</span>=$(<span style="font-weight: bold;">type</span> realpath &gt;/dev/null &amp;&amp; realpath <span style="font-style: italic;">"${_logfile_rel}"</span> || <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${_logfile_rel}"</span>)

  <span style="font-weight: bold; font-style: italic;">mailfrom</span>=${<span style="font-weight: bold; font-style: italic;">MAIL_FROM</span>}
  <span style="font-weight: bold; font-style: italic;">mailto</span>=${<span style="font-weight: bold; font-style: italic;">MAIL_TO</span>}
  <span style="font-weight: bold; font-style: italic;">subject</span>=<span style="font-style: italic;">"${_result}: ${_command} @ $(uname -n)"</span>
  <span style="font-weight: bold; font-style: italic;">msg1</span>=<span style="font-style: italic;">"command line      : ${_whole_command}"</span>
  <span style="font-weight: bold; font-style: italic;">msg2</span>=<span style="font-style: italic;">"exit status(nohup): $3"</span>
  <span style="font-weight: bold; font-style: italic;">msg3</span>=<span style="font-style: italic;">"execution time    : $5"</span>
  <span style="font-weight: bold; font-style: italic;">msg4</span>=<span style="font-style: italic;">"pwd               : $(pwd)"</span>
  <span style="font-weight: bold; font-style: italic;">msg5</span>=<span style="font-style: italic;">"Log data (stdout/stderr) is stored in following file:"</span>
  <span style="font-weight: bold; font-style: italic;">msg6</span>=<span style="font-style: italic;">"${_logfile}"</span>

  {
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg1}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg2}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg3}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg4}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg5}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg6}"</span>
  } | sendmail.py -f <span style="font-style: italic;">"${mailfrom}"</span> -s <span style="font-style: italic;">"${subject}"</span> <span style="font-style: italic;">"${mailto}"</span>
}
<span style="font-weight: bold;">export</span> -f mailtome

<span style="font-weight: bold;">if</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -eq 1 ] &amp;&amp; [ -x <span style="font-style: italic;">"$1"</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">utility</span>=<span style="font-style: italic;">"$1"</span>
<span style="font-weight: bold;">elif</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ] &amp;&amp; <span style="font-weight: bold;">type</span> <span style="font-style: italic;">"$1"</span> &gt;/dev/null; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">utility</span>=<span style="font-style: italic;">"$*"</span>
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">LOG_DIR</span>=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/var/log/$(basename <span style="font-style: italic;">"$0"</span>)
<span style="font-weight: bold; font-style: italic;">fname_default</span>=$(date <span style="font-style: italic;">'+%Y%m%d_%H%M%S'</span>)_$(basename <span style="font-style: italic;">"$0"</span>)-$(basename <span style="font-style: italic;">"$1"</span>)

<span style="font-weight: bold;">if</span> [ ! -d <span style="font-style: italic;">"${LOG_DIR}"</span> ]; <span style="font-weight: bold;">then</span>
  mkdir -p <span style="font-style: italic;">"${LOG_DIR}"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">if</span> [ -v <span style="font-style: italic;">"opt_logfile"</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">logfile</span>=${<span style="font-weight: bold; font-style: italic;">opt_logfile</span>}
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold; font-style: italic;">logfile</span>=<span style="font-style: italic;">"${LOG_DIR}/${fname_default}.log"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">if</span> [ -v <span style="font-style: italic;">"opt_pidfile"</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">pidfile</span>=${<span style="font-weight: bold; font-style: italic;">opt_pidfile</span>}
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold; font-style: italic;">pidfile</span>=<span style="font-style: italic;">"${LOG_DIR}/${fname_default}.pid"</span>
<span style="font-weight: bold;">fi</span>

(
  <span style="font-weight: bold; font-style: italic;">start_time</span>=$(date +%s)
  nohup nice -n 10 ${<span style="font-weight: bold; font-style: italic;">utility</span>} &gt;&gt;<span style="font-style: italic;">"${logfile}"</span> &lt;/dev/null 2&gt;&amp;1 &amp;
  <span style="font-weight: bold; font-style: italic;">PID</span>=$<span style="font-weight: bold; font-style: italic;">!</span>
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">PID</span> &gt;<span style="font-style: italic;">"${pidfile}"</span>
  <span style="font-weight: bold;">wait</span> $<span style="font-weight: bold; font-style: italic;">PID</span>
  <span style="font-weight: bold; font-style: italic;">EXIT_STATUS</span>=$<span style="font-weight: bold; font-style: italic;">?</span>
  <span style="font-weight: bold; font-style: italic;">end_time</span>=$(date +%s)
  <span style="font-weight: bold; font-style: italic;">exec_time</span>=$((end_time-start_time))
  ((<span style="font-weight: bold; font-style: italic;">h</span>=exec_time/3600))
  ((<span style="font-weight: bold; font-style: italic;">m</span>=(exec_time%3600)/60))
  ((<span style="font-weight: bold; font-style: italic;">s</span>=exec_time%60))
  <span style="font-weight: bold; font-style: italic;">exec_time_str</span>=$(printf <span style="font-style: italic;">"%02d:%02d:%02d"</span> $<span style="font-weight: bold; font-style: italic;">h</span> $<span style="font-weight: bold; font-style: italic;">m</span> $<span style="font-weight: bold; font-style: italic;">s</span>)
  mailtome <span style="font-style: italic;">"$1"</span> <span style="font-style: italic;">"${utility}"</span> $<span style="font-weight: bold; font-style: italic;">EXIT_STATUS</span> <span style="font-style: italic;">"${logfile}"</span> ${<span style="font-weight: bold; font-style: italic;">exec_time_str</span>}
)
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$1 has finished successfully"</span>

<span style="font-weight: bold;">exit</span> 0
</pre>
</div>
</div>
</div>

<div id="outline-container-org2bbb8e2" class="outline-2">
<h2 id="org2bbb8e2">sendmail.py</h2>
<div class="outline-text-2" id="text-org2bbb8e2">
<p>
Utility for sendind email programatically
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>

<span style="font-weight: bold;">import</span> sys
<span style="font-weight: bold;">import</span> argparse
<span style="font-weight: bold;">import</span> subprocess
<span style="font-weight: bold;">import</span> smtplib
<span style="font-weight: bold;">import</span> ssl
<span style="font-weight: bold;">from</span> email.mime.text <span style="font-weight: bold;">import</span> MIMEText
<span style="font-weight: bold;">from</span> email.utils <span style="font-weight: bold;">import</span> formatdate

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">sendmail</span>(mail_to, mail_from, subject, message):
    <span style="font-weight: bold; font-style: italic;">smtp_host</span> = <span style="font-style: italic;">'smtp.daisychain.jp'</span>
    <span style="font-weight: bold; font-style: italic;">smtp_port</span> = <span style="font-style: italic;">'465'</span>
    <span style="font-weight: bold; font-style: italic;">smtp_user</span> = <span style="font-style: italic;">'&lt;&lt;email()&gt;&gt;'</span>.split(sep=<span style="font-style: italic;">'@'</span>)[0]
    <span style="font-weight: bold; font-style: italic;">smtp_pass</span> = subprocess.run([<span style="font-style: italic;">"pass {}:{}/{} | head -1"</span>.<span style="font-weight: bold;">format</span>(smtp_host, smtp_port, smtp_user)], stdout=subprocess.PIPE, shell=<span style="font-weight: bold; text-decoration: underline;">True</span>).stdout.decode().strip()

    <span style="font-weight: bold; font-style: italic;">mime_msg</span> = MIMEText(message)
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">'Subject'</span>] = subject
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">'From'</span>] = mail_from
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">'To'</span>] = mail_to
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">"Date"</span>] = formatdate(<span style="font-weight: bold; text-decoration: underline;">None</span>, <span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold;">if</span> smtp_port == <span style="font-style: italic;">'465'</span>:
        <span style="font-weight: bold; font-style: italic;">context</span> = ssl.create_default_context()
        <span style="font-weight: bold; font-style: italic;">smtp</span> = smtplib.SMTP_SSL(smtp_host, smtp_port, context=context)

    <span style="font-weight: bold;">if</span> smtp <span style="font-weight: bold;">is</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
        smtp.login(smtp_user, smtp_pass)
        smtp.sendmail(mail_from, mail_to, mime_msg.as_string())
        smtp.<span style="font-weight: bold; text-decoration: underline;">quit</span>()


<span style="font-weight: bold; font-style: italic;">DESC</span> = <span style="font-style: italic;">'sendmail.py sends mail'</span>
<span style="font-weight: bold; font-style: italic;">parser</span> = argparse.ArgumentParser(description=DESC)
parser.add_argument(<span style="font-style: italic;">'-s'</span>, <span style="font-style: italic;">'--subject'</span>)
parser.add_argument(<span style="font-style: italic;">'-f'</span>, <span style="font-style: italic;">'--mailfrom'</span>)
parser.add_argument(<span style="font-style: italic;">'to'</span>)
<span style="font-weight: bold; font-style: italic;">args</span> = parser.parse_args()

<span style="font-weight: bold; font-style: italic;">message</span> = sys.stdin.read()
sendmail(args.to, args.mailfrom, args.subject, message)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7633708" class="outline-2">
<h2 id="org7633708">pwsudo</h2>
<div class="outline-text-2" id="text-org7633708">
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">_userid</span>=$(whoami)
<span style="font-weight: bold; font-style: italic;">_hostname</span>=$(hostname)

<span style="font-weight: bold;">if</span> pass show <span style="font-style: italic;">"${_hostname}/${_userid}"</span> &gt;/dev/null 2&gt;&amp;1; <span style="font-weight: bold;">then</span>
  pass show <span style="font-style: italic;">"${_hostname}/${_userid}"</span> | head -1 | sudo -S $<span style="font-weight: bold; font-style: italic;">*</span>
<span style="font-weight: bold;">else</span>
  sudo $<span style="font-weight: bold; font-style: italic;">*</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8efcac8" class="outline-2">
<h2 id="org8efcac8">gitsync</h2>
<div class="outline-text-2" id="text-org8efcac8">
<ul class="org-ul">
<li><p>
gitsync-local
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">usage</span>() {
  cat &lt;&lt;_EOT_
<span style="font-weight: bold;">Usage:</span>
<span style="font-weight: bold;">  $0 &lt;prj_root&gt;</span>

<span style="font-weight: bold;">Description:</span>
<span style="font-weight: bold;">  $0 adds file changes in git projects under root_dir to the repository</span>

<span style="font-weight: bold;">Options:</span>
<span style="font-weight: bold;">  prj_root:  a root directory that has git projects as children</span>

<span style="font-weight: bold;">_EOT_</span>
  <span style="font-weight: bold;">exit</span> 1
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">parameter check</span>
<span style="font-weight: bold;">if</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -ne 1 ]; <span style="font-weight: bold;">then</span>
  usage
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>
<span style="font-weight: bold; font-style: italic;">root_dir</span>=$<span style="font-weight: bold; font-style: italic;">1</span>

<span style="font-weight: bold;">if</span> find ${<span style="font-weight: bold; font-style: italic;">root_dir</span>} -mindepth 1 -maxdepth 1 <span style="font-style: italic;">\(</span> -type l -o -type d <span style="font-style: italic;">\)</span> | {
    <span style="font-weight: bold;">while </span><span style="font-weight: bold;">read</span> repo
    <span style="font-weight: bold;">do</span>
      <span style="font-weight: bold;">cd</span> ${<span style="font-weight: bold; font-style: italic;">repo</span>} || <span style="font-weight: bold;">continue</span>

      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">skip if this is not git repo</span>
      git rev-parse || <span style="font-weight: bold;">continue</span>

      <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"repository: ${repo}"</span>

      <span style="font-weight: bold;">cd</span> <span style="font-weight: bold;">`git rev-parse --show-toplevel`</span>
      <span style="font-weight: bold; font-style: italic;">sync_mode</span>=<span style="font-weight: bold;">`git config sync.mode`</span>
      <span style="font-weight: bold;">case</span> <span style="font-style: italic;">"${sync_mode}"</span><span style="font-weight: bold;"> in</span>
      <span style="font-style: italic;">"auto"</span> )
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Remove deleted files</span>
        git ls-files --deleted -z | xargs -0 git rm &gt;/dev/null 2&gt;&amp;1
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Add new files</span>
        git add . &gt;/dev/null 2&gt;&amp;1
        git commit -m <span style="font-style: italic;">"$(date)"</span>;;
      <span style="font-style: italic;">"manual"</span> )
        git add -u &gt;/dev/null 2&gt;&amp;1
        git commit -m <span style="font-style: italic;">"$(date)"</span>;;
      <span style="font-style: italic;">"none"</span> )
      ;;
      <span style="font-weight: bold;">esac</span>
    <span style="font-weight: bold;">done</span>
  }
<span style="font-weight: bold;">then</span>
  printf <span style="font-style: italic;">"\nAll done.\n"</span>
<span style="font-weight: bold;">else</span>
  printf <span style="font-style: italic;">"\nFix and redo.\n"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div></li>

<li><p>
gitsync-remote
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Local bare repository name</span>
<span style="font-weight: bold; font-style: italic;">syncrepo</span>=origin

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Display repository name only once</span>
<span style="font-weight: bold;">log_repo</span>() {
  [ <span style="font-style: italic;">"x$lastrepo"</span> == <span style="font-style: italic;">"x$repo"</span> ] || {
    printf <span style="font-style: italic;">"\nREPO: ${repo}\n"</span>
    <span style="font-weight: bold; font-style: italic;">lastrepo</span>=<span style="font-style: italic;">"$repo"</span>
  }
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Log a message for a repository</span>
<span style="font-weight: bold;">log_msg</span>() {
  log_repo
  printf <span style="font-style: italic;">"  $1\n"</span>
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">fast-forward reference $1 to $syncrepo/$1</span>
<span style="font-weight: bold;">fast_forward_ref</span>() {
  log_msg <span style="font-style: italic;">"fast-forwarding ref $1"</span>
  <span style="font-weight: bold; font-style: italic;">current_ref</span>=$(cat .git/HEAD)
  <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"x$current_ref"</span> = <span style="font-style: italic;">"xref: refs/heads/$1"</span> ]
  <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Check for dirty index</span>
    <span style="font-weight: bold; font-style: italic;">files</span>=$(git diff-index --name-only HEAD --)
    git merge refs/remotes/$<span style="font-weight: bold; font-style: italic;">syncrepo</span>/$<span style="font-weight: bold; font-style: italic;">1</span>
  <span style="font-weight: bold;">else</span>
    git branch -f $<span style="font-weight: bold; font-style: italic;">1</span> refs/remotes/$<span style="font-weight: bold; font-style: italic;">syncrepo</span>/$<span style="font-weight: bold; font-style: italic;">1</span>
  <span style="font-weight: bold;">fi</span>
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Push reference $1 to $syncrepo</span>
<span style="font-weight: bold;">push_ref</span>() {
  log_msg <span style="font-style: italic;">"Pushing ref $1"</span>
  <span style="font-weight: bold;">if</span> ! git push --tags --quiet $<span style="font-weight: bold; font-style: italic;">syncrepo</span> $<span style="font-weight: bold; font-style: italic;">1</span>
  <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold;">exit</span> 1
  <span style="font-weight: bold;">fi</span>
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Check if a ref can be moved</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">- fast-forwards if behind the sync repo and is fast-forwardable</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">- Does nothing if ref is up to date</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">- Pushes ref to $syncrepo if ref is ahead of syncrepo and fastforwardable</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">- Fails if ref and $syncrop/ref have diverged</span>
<span style="font-weight: bold;">check_ref</span>() {
  <span style="font-weight: bold; font-style: italic;">revlist1</span>=$(git rev-list refs/remotes/$<span style="font-weight: bold; font-style: italic;">syncrepo</span>/$<span style="font-weight: bold; font-style: italic;">1</span>..$<span style="font-weight: bold; font-style: italic;">1</span>)
  <span style="font-weight: bold; font-style: italic;">revlist2</span>=$(git rev-list $<span style="font-weight: bold; font-style: italic;">1</span>..refs/remotes/$<span style="font-weight: bold; font-style: italic;">syncrepo</span>/$<span style="font-weight: bold; font-style: italic;">1</span>)
  <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"x$revlist1"</span> = <span style="font-style: italic;">"x"</span> -a <span style="font-style: italic;">"x$revlist2"</span> = <span style="font-style: italic;">"x"</span> ]
  <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Ref $1 is up to date.</span>
    :
  <span style="font-weight: bold;">elif</span> [ <span style="font-style: italic;">"x$revlist1"</span> = <span style="font-style: italic;">"x"</span> ]
  <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Ref $1 is behind $syncrepo/$1 and can be fast-forwarded.</span>
    fast_forward_ref $<span style="font-weight: bold; font-style: italic;">1</span> || <span style="font-weight: bold;">exit</span> 1
  <span style="font-weight: bold;">elif</span> [ <span style="font-style: italic;">"x$revlist2"</span> = <span style="font-style: italic;">"x"</span> ]
  <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Ref $1 is ahead of $syncrepo/$1 and can be pushed.</span>
    push_ref $<span style="font-weight: bold; font-style: italic;">1</span> || <span style="font-weight: bold;">exit</span> 1
  <span style="font-weight: bold;">else</span>
    log_msg <span style="font-style: italic;">"Ref $1 and $syncrepo/$1 have diverged."</span>
    <span style="font-weight: bold;">exit</span> 1
  <span style="font-weight: bold;">fi</span>
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Check all local refs with matching refs in the $syncrepo</span>
<span style="font-weight: bold;">check_refs</span> () {
  git for-each-ref refs/heads/* | <span style="font-weight: bold;">while </span><span style="font-weight: bold;">read</span> sha1 commit ref
  <span style="font-weight: bold;">do</span>
    <span style="font-weight: bold; font-style: italic;">ref</span>=${<span style="font-weight: bold; font-style: italic;">ref</span>/refs<span style="font-style: italic;">\/</span>heads<span style="font-style: italic;">\/</span>/}
    git for-each-ref refs/remotes/$<span style="font-weight: bold; font-style: italic;">syncrepo</span>/$<span style="font-weight: bold; font-style: italic;">ref</span> | <span style="font-weight: bold;">while </span><span style="font-weight: bold;">read</span> sha2 commit ref2
    <span style="font-weight: bold;">do</span>
      <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"x$sha1"</span> != <span style="font-style: italic;">"x"</span> -a <span style="font-style: italic;">"x$sha2"</span> != <span style="font-style: italic;">"x"</span> ]
      <span style="font-weight: bold;">then</span>
        check_ref $<span style="font-weight: bold; font-style: italic;">ref</span> || <span style="font-weight: bold;">exit</span> 1
      <span style="font-weight: bold;">fi</span>
    <span style="font-weight: bold;">done</span>
  <span style="font-weight: bold;">done</span>
}

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">parameter check</span>
<span style="font-weight: bold;">if</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -ne 1 ]; <span style="font-weight: bold;">then</span>
  usage
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>
<span style="font-weight: bold; font-style: italic;">root_dir</span>=$<span style="font-weight: bold; font-style: italic;">1</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">For all repositories under $reporoot</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">Check all refs matching $syncrepo and fast-forward, or push as necessary</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">to synchronize the ref with $syncrepo</span>
<span style="font-weight: bold; font-style: italic;">#   </span><span style="font-weight: bold; font-style: italic;">Bail out if ref is not fastforwardable so user can fix and rerun</span>
<span style="font-weight: bold; font-style: italic;">retval</span>=0
<span style="font-weight: bold;">if</span> find ${<span style="font-weight: bold; font-style: italic;">root_dir</span>} -mindepth 1 -maxdepth 1 <span style="font-style: italic;">\(</span> -type l -o -type d <span style="font-style: italic;">\)</span> | {
    <span style="font-weight: bold;">while </span><span style="font-weight: bold;">read</span> repo
    <span style="font-weight: bold;">do</span>
      <span style="font-weight: bold;">cd</span> ${<span style="font-weight: bold; font-style: italic;">repo</span>}

      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">continue if this is not git repo</span>
      git rev-parse 2&gt; /dev/null || <span style="font-weight: bold;">continue</span>

      <span style="font-weight: bold; font-style: italic;">upd</span>=$(git remote update $<span style="font-weight: bold; font-style: italic;">syncrepo</span> 2&gt;&amp;1 || <span style="font-weight: bold; font-style: italic;">retval</span>=1)
      [ <span style="font-style: italic;">"x$upd"</span> = <span style="font-style: italic;">"xFetching $syncrepo"</span> ] || {
        log_repo
        printf <span style="font-style: italic;">"$upd\n"</span>
      }
      check_refs || <span style="font-weight: bold; font-style: italic;">retval</span>=1
    <span style="font-weight: bold;">done</span>
    <span style="font-weight: bold;">exit</span> $<span style="font-weight: bold; font-style: italic;">retval</span>
  }
<span style="font-weight: bold;">then</span>
  printf <span style="font-style: italic;">"\nAll done.\n"</span>
<span style="font-weight: bold;">else</span>
  printf <span style="font-style: italic;">"\nFix and redo.\n"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">exit</span> $<span style="font-weight: bold; font-style: italic;">retval</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p>
<p class="validation"></p>
</div>
</body>
</html>
