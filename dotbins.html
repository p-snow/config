<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Utility Programs (.bin)</title>
<meta name="generator" content="Org mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">Utility Programs (.bin)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3e91bf1">Local file clean-up (tidyup)</a></li>
<li><a href="#org9b1ce74">Database back-up script</a></li>
<li><a href="#org1d17164">Snapshots taking</a></li>
<li><a href="#org75eece3">backup scripts</a></li>
<li><a href="#org0c94287">nhp</a></li>
<li><a href="#org43283be">sendmail.py</a></li>
<li><a href="#orgda3b3d8">pwsudo</a></li>
</ul>
</div>
</div>

<div id="outline-container-org3e91bf1" class="outline-2">
<h2 id="org3e91bf1">Local file clean-up (tidyup)</h2>
<div class="outline-text-2" id="text-org3e91bf1">
<ul class="org-ul">
<li><p>
tidyup
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>

<span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> time
<span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">import</span> shutil
<span style="font-weight: bold;">import</span> glob
<span style="font-weight: bold;">from</span> send2trash <span style="font-weight: bold;">import</span> send2trash

<span style="font-weight: bold; font-style: italic;">TRASH_DIR</span> = os.environ[<span style="font-style: italic;">'HOME'</span>] + <span style="font-style: italic;">'/.local/share/Trash/files/'</span>
<span style="font-weight: bold; font-style: italic;">TIDY_DIRS</span> = <span style="font-weight: bold;">filter</span>(<span style="font-weight: bold;">lambda</span> x: os.path.isdir(x),
                   <span style="font-weight: bold;">list</span>(<span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> x: os.path.join(os.environ[<span style="font-style: italic;">'HOME'</span>], x), [<span style="font-style: italic;">'tmp'</span>, <span style="font-style: italic;">'Downloads'</span>]))
                   + glob.glob(os.path.join(os.environ[<span style="font-style: italic;">'HOME'</span>], <span style="font-style: italic;">'var/tmp/*'</span>)))

<span style="font-weight: bold; font-style: italic;">MAX_STAY_DAYS_IN_TRASH</span> = 7
<span style="font-weight: bold; font-style: italic;">MAX_NEGLECTED_DAYS_IN_TIDY_DIRS</span> = 14

<span style="font-weight: bold; font-style: italic;">suffixes</span> = [<span style="font-style: italic;">'B'</span>, <span style="font-style: italic;">'KB'</span>, <span style="font-style: italic;">'MB'</span>, <span style="font-style: italic;">'GB'</span>, <span style="font-style: italic;">'TB'</span>, <span style="font-style: italic;">'PB'</span>]
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">humansize</span>(nbytes):
    <span style="font-weight: bold; font-style: italic;">i</span> = 0
    <span style="font-weight: bold;">while</span> nbytes &gt;= 1024 <span style="font-weight: bold;">and</span> i &lt; <span style="font-weight: bold;">len</span>(suffixes)-1:
        <span style="font-weight: bold; font-style: italic;">nbytes</span> /= 1024.
        <span style="font-weight: bold; font-style: italic;">i</span> += 1
    <span style="font-weight: bold; font-style: italic;">f</span> = (<span style="font-style: italic;">'%.2f'</span> % nbytes).rstrip(<span style="font-style: italic;">'0'</span>).rstrip(<span style="font-style: italic;">'.'</span>)
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'%s %s'</span> % (f, suffixes[i])

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_size</span>(start_path = <span style="font-style: italic;">'.'</span>):
    <span style="font-weight: bold; font-style: italic;">total_size</span> = 0
    <span style="font-weight: bold;">for</span> dirpath, dirnames, filenames <span style="font-weight: bold;">in</span> os.walk(start_path):
        <span style="font-weight: bold;">for</span> f <span style="font-weight: bold;">in</span> filenames:
            <span style="font-weight: bold; font-style: italic;">fp</span> = os.path.join(dirpath, f)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">skip if it is symbolic link</span>
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> os.path.islink(fp):
                <span style="font-weight: bold; font-style: italic;">total_size</span> += os.path.getsize(fp)

    <span style="font-weight: bold;">return</span> total_size

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'{0} starts at {1}\n'</span>.<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
                                   datetime.datetime.now()))

<span style="font-weight: bold; font-style: italic;">NOW</span> = time.time()

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'--{0} starts to move files neglected more than {1} days to trash box.\n'</span>
      .<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
              MAX_NEGLECTED_DAYS_IN_TIDY_DIRS))

<span style="font-weight: bold; font-style: italic;">tidyup_lists</span> = <span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> x: <span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> y: os.path.join(x, y), os.listdir(x)), TIDY_DIRS)
<span style="font-weight: bold;">for</span> a_file <span style="font-weight: bold;">in</span> [item <span style="font-weight: bold;">for</span> sublist <span style="font-weight: bold;">in</span> tidyup_lists <span style="font-weight: bold;">for</span> item <span style="font-weight: bold;">in</span> sublist]:
    <span style="font-weight: bold; font-style: italic;">atime</span> = os.lstat(a_file).st_atime
    <span style="font-weight: bold; font-style: italic;">delta_atime</span> = datetime.timedelta(seconds=(NOW - atime))
    <span style="font-weight: bold;">if</span> delta_atime &gt; datetime.timedelta(days = MAX_NEGLECTED_DAYS_IN_TIDY_DIRS):
        send2trash(a_file)
        <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'moveed to trash: {}'</span>.<span style="font-weight: bold;">format</span>(a_file))

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'--{0} starts to remove files staying more than {1} days in trash box.'</span>
      .<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
              MAX_STAY_DAYS_IN_TRASH))

<span style="font-weight: bold; font-style: italic;">rbytes_total</span> = 0
<span style="font-weight: bold;">for</span> trash_file <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">map</span>(<span style="font-weight: bold;">lambda</span> fname: os.path.join(TRASH_DIR, fname), os.listdir(TRASH_DIR)):
    <span style="font-weight: bold; font-style: italic;">lstat</span> = os.lstat(trash_file)
    <span style="font-weight: bold; font-style: italic;">delta_time</span> = datetime.timedelta(seconds=(NOW - <span style="font-weight: bold;">max</span>(lstat.st_atime, lstat.st_ctime)))
    <span style="font-weight: bold;">if</span> delta_time &gt; datetime.timedelta(days = MAX_STAY_DAYS_IN_TRASH):
        <span style="font-weight: bold; font-style: italic;">method</span> = <span style="font-style: italic;">'removed'</span>
        <span style="font-weight: bold; font-style: italic;">fname</span> = os.path.basename(trash_file)
        <span style="font-weight: bold;">if</span> os.path.islink(trash_file):
            <span style="font-weight: bold; font-style: italic;">method</span> = <span style="font-style: italic;">'unlinked'</span>
            <span style="font-weight: bold; font-style: italic;">fsize</span> = <span style="font-style: italic;">'N/A'</span>
            os.unlink(trash_file)
        <span style="font-weight: bold;">elif</span> os.path.isfile(trash_file):
            <span style="font-weight: bold; font-style: italic;">rbytes</span> = os.path.getsize(trash_file)
            <span style="font-weight: bold; font-style: italic;">rbytes_total</span> += rbytes
            <span style="font-weight: bold; font-style: italic;">fsize</span> = humansize(rbytes)
            os.remove(trash_file)
        <span style="font-weight: bold;">elif</span> os.path.isdir(trash_file):
            <span style="font-weight: bold; font-style: italic;">rbytes</span> = get_size(trash_file)
            <span style="font-weight: bold; font-style: italic;">rbytes_total</span> += rbytes
            <span style="font-weight: bold; font-style: italic;">fsize</span> = humansize(rbytes)
            <span style="font-weight: bold; font-style: italic;">fname</span> += <span style="font-style: italic;">'/'</span>
            shutil.rmtree(trash_file)
        <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'{}: [{:&gt;9}] {}'</span>.<span style="font-weight: bold;">format</span>(method, fsize, fname))

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'--{0} removes [{1}] in total.\n'</span>
      .<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
              humansize(rbytes_total)))

<span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'{0} ends at {1}\n'</span>.<span style="font-weight: bold;">format</span>(os.path.basename(__file__),
                                 datetime.datetime.now()))
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org9b1ce74" class="outline-2">
<h2 id="org9b1ce74">Database back-up script</h2>
<div class="outline-text-2" id="text-org9b1ce74">
<ul class="org-ul">
<li>PostgreSQL</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Usage: $ postgres_backup &lt;db_name&gt; &lt;backup_dir&gt;</span>

<span style="font-weight: bold; font-style: italic;">POSTGRES_DBNAME</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
<span style="font-weight: bold; font-style: italic;">BACKUP_DIR</span>=$<span style="font-weight: bold; font-style: italic;">2</span>
<span style="font-weight: bold; font-style: italic;">DATE</span>=<span style="font-style: italic;">"$(date +%Y%m%d_%H%M)"</span>

pg_dump --format=custom ${<span style="font-weight: bold; font-style: italic;">POSTGRES_DBNAME</span>} &gt; ${<span style="font-weight: bold; font-style: italic;">BACKUP_DIR</span>}/${<span style="font-weight: bold; font-style: italic;">DATE</span>}_${<span style="font-weight: bold; font-style: italic;">POSTGRES_DBNAME</span>}.custom || <span style="font-weight: bold;">exit</span> 1

<span style="font-weight: bold;">exit</span> 0
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d17164" class="outline-2">
<h2 id="org1d17164">Snapshots taking</h2>
<div class="outline-text-2" id="text-org1d17164">
<ul class="org-ul">
<li><p>
snapshot.sh
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">DATETIME</span>=<span style="font-weight: bold;">`date "+%Y%m%d-%H%M"`</span>
<span style="font-weight: bold; font-style: italic;">BTRFS_MNT</span>=<span style="font-style: italic;">"/mnt/ssd01"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">take a snapshot in btrfs</span>
<span style="font-weight: bold;">if</span> mountpoint ${<span style="font-weight: bold; font-style: italic;">BTRFS_MNT</span>} &gt;/dev/null 2&gt;&amp;1; <span style="font-weight: bold;">then</span>
  btrfs subvolume snapshot <span style="font-style: italic;">"${BTRFS_MNT}/doc"</span> <span style="font-style: italic;">"${BTRFS_MNT}/snapshots/doc-${DATETIME}"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org75eece3" class="outline-2">
<h2 id="org75eece3">backup scripts</h2>
<div class="outline-text-2" id="text-org75eece3">
<ul class="org-ul">
<li><p>
back<sub>btrfs.sh</sub>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">src_dev</span>=/mnt/ssd01
<span style="font-weight: bold; font-style: italic;">src_snap_dir</span>=<span style="font-style: italic;">"${src_dev}"</span>/snapshots
<span style="font-weight: bold; font-style: italic;">src_back_dir</span>=<span style="font-style: italic;">"${src_dev}"</span>/backups
<span style="font-weight: bold; font-style: italic;">dst_dev</span>=/mnt/hdd01
<span style="font-weight: bold; font-style: italic;">dst_back_dir</span>=<span style="font-style: italic;">"${dst_dev}"</span>/backups

<span style="font-weight: bold; font-style: italic;">parent</span>=$(ls -d <span style="font-style: italic;">"${src_back_dir}"</span>/doc-* 2&gt;/dev/null | sort | tail -1 | xargs basename)
<span style="font-weight: bold; font-style: italic;">snap_earliest</span>=$(ls -d <span style="font-style: italic;">"${src_snap_dir}"</span>/doc-* 2&gt;/dev/null | sort | head -1 | xargs basename)
<span style="font-weight: bold; font-style: italic;">snap_latest</span>=$(ls -d <span style="font-style: italic;">"${src_snap_dir}"</span>/doc-* 2&gt;/dev/null | sort | tail -1 | xargs basename)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">backup root snapshot if nothing exists</span>
<span style="font-weight: bold;">if</span> [ -z <span style="font-style: italic;">"${parent}"</span> ] &amp;&amp; [ -n <span style="font-style: italic;">"${snap_earliest}"</span> ]; <span style="font-weight: bold;">then</span>
  btrfs subvolume snapshot -r <span style="font-style: italic;">"${src_snap_dir}/${snap_earliest}"</span> <span style="font-style: italic;">"${src_back_dir}/${snap_earliest}"</span>
  pwsudo btrfs send <span style="font-style: italic;">"${src_back_dir}/${snap_earliest}"</span> | sudo btrfs receive <span style="font-style: italic;">"${dst_back_dir}"</span>
  <span style="font-weight: bold; font-style: italic;">parent</span>=<span style="font-style: italic;">"${snap_earliest}"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">backup latest snapshot by sending differential data</span>
<span style="font-weight: bold;">if</span> [ -n <span style="font-style: italic;">"${parent}"</span> ] &amp;&amp; [[ <span style="font-style: italic;">"${parent}"</span> &lt; <span style="font-style: italic;">"${snap_latest}"</span> ]]; <span style="font-weight: bold;">then</span>
  btrfs subvolume snapshot  -r <span style="font-style: italic;">"${src_snap_dir}/${snap_latest}"</span> <span style="font-style: italic;">"${src_back_dir}/${snap_latest}"</span>
  pwsudo btrfs send -p <span style="font-style: italic;">"${src_back_dir}/${parent}"</span> <span style="font-style: italic;">"${src_back_dir}/${snap_latest}"</span> | sudo btrfs receive <span style="font-style: italic;">"${dst_back_dir}"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div></li>
<li><p>
back<sub>rsync.sh</sub>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">OPT</span>=<span style="font-style: italic;">"-aPh"</span>
<span style="font-weight: bold; font-style: italic;">LINK</span>=<span style="font-style: italic;">"--link-dest=../last/"</span>
<span style="font-weight: bold; font-style: italic;">DEST</span>=<span style="font-style: italic;">"ns01:~/share/backups"</span>
<span style="font-weight: bold; font-style: italic;">DATETIME</span>=<span style="font-weight: bold;">`date "+%Y%m%d-%H%M"`</span>

ssh -q -o <span style="font-weight: bold; font-style: italic;">BatchMode</span>=<span style="font-style: italic;">"yes"</span> -o <span style="font-weight: bold; font-style: italic;">ConnectTimeout</span>=10 ns01 <span style="font-style: italic;">"(cd ~/share/backups; mkdir -p pc01 sv04; exit)"</span> || <span style="font-weight: bold;">exit</span> 1

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">take a snapshot for pc01</span>
<span style="font-weight: bold;">if</span> ssh ns01 <span style="font-style: italic;">"[ -h ~/share/backups/pc01/last ]"</span>; <span style="font-weight: bold;">then</span>
  rsync -aPhrv $<span style="font-weight: bold; font-style: italic;">LINK</span> --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_pc01.txt ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/pc01/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
  ssh ns01 <span style="font-style: italic;">"(cd share/backups/pc01; unlink last; ln -s ${DATETIME} last)"</span>
<span style="font-weight: bold;">else</span>
  rsync -aAXrv --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_pc01.txt ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/pc01/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
  ssh ns01 <span style="font-style: italic;">"(cd share/backups/pc01; ln -s ${DATETIME} last)"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">take a snapshot for sv04</span>
<span style="font-weight: bold;">if</span> mountpoint ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/mnt/sv04 &gt;/dev/null 2&gt;&amp;1; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">if</span> ssh ns01 <span style="font-style: italic;">"[ -h ~/share/backups/sv04/last ]"</span>; <span style="font-weight: bold;">then</span>
    rsync -aPhrv $<span style="font-weight: bold; font-style: italic;">LINK</span> --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_sv04.txt ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/mnt/sv04/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/sv04/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
    ssh ns01 <span style="font-style: italic;">"(cd share/backups/sv04; unlink last; ln -s ${DATETIME} last)"</span>
  <span style="font-weight: bold;">else</span>
    rsync -aAXrv --exclude-from=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/.config/rsync/exclude_sv04.txt ${<span style="font-weight: bold; font-style: italic;">HOME</span>}/mnt/sv04/ ${<span style="font-weight: bold; font-style: italic;">DEST</span>}/sv04/${<span style="font-weight: bold; font-style: italic;">DATETIME</span>}
    ssh ns01 <span style="font-style: italic;">"(cd share/backups/sv04; ln -s ${DATETIME} last)"</span>
  <span style="font-weight: bold;">fi</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>
<ul class="org-ul">
<li><p>
rsync exclude file for pc01
</p>
<div class="org-src-container">
<pre class="src src-conf">+ var
+ var/log
+ var/log/**
- var/lib/dash
+ var/lib
+ var/lib/**
+ work
+ work/**
+ git
+ git/**
- *
</pre>
</div></li>
<li><p>
rsync exclude file for sv04
</p>
<div class="org-src-container">
<pre class="src src-conf">+ var
+ var/backup
+ var/backup/**
- *
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org0c94287" class="outline-2">
<h2 id="org0c94287">nhp</h2>
<div class="outline-text-2" id="text-org0c94287">
<p>
Exec command in background
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold;">readonly</span> <span style="font-weight: bold; font-style: italic;">MAIL_FROM</span>=<span style="font-style: italic;">"&lt;&lt;email()&gt;&gt;"</span>
<span style="font-weight: bold;">readonly</span> <span style="font-weight: bold; font-style: italic;">MAIL_TO</span>=<span style="font-style: italic;">"&lt;&lt;email()&gt;&gt;"</span>

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">usage</span>() {
  cat &lt;&lt;_EOT_
<span style="font-weight: bold;">Usage:</span>
<span style="font-weight: bold;">  $(basename "$0") [options] command|exefile</span>

<span style="font-weight: bold;">Description:</span>
<span style="font-weight: bold;">  $(basename "$0") executes command(s) in back-ground process continueing after the user logs out</span>

<span style="font-weight: bold;">Options:</span>
<span style="font-weight: bold;">  -l &lt;logfile&gt;  log file name</span>
<span style="font-weight: bold;">  -p &lt;pidfile&gt;  process id file name</span>
<span style="font-weight: bold;">  -h            help</span>

<span style="font-weight: bold;">_EOT_</span>
  <span style="font-weight: bold;">exit</span> 1
}

<span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"${OPTIND}"</span> = 1 ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">while </span><span style="font-weight: bold;">getopts</span> l:p:h OPT
  <span style="font-weight: bold;">do</span>
    <span style="font-weight: bold;">case</span> ${<span style="font-weight: bold; font-style: italic;">OPT</span>} <span style="font-weight: bold;">in</span>
    l)
      <span style="font-weight: bold; font-style: italic;">opt_logfile</span>=${<span style="font-weight: bold; font-style: italic;">OPTARG</span>}
      ;;
    p)
      <span style="font-weight: bold; font-style: italic;">opt_pidfile</span>=${<span style="font-weight: bold; font-style: italic;">OPTARG</span>}
      ;;
    h)
      usage
      ;;
    <span style="font-style: italic;">\?</span>)
      <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Try to enter the h option."</span> 1&gt;&amp;2
      ;;
    <span style="font-weight: bold;">esac</span>
  <span style="font-weight: bold;">done</span>
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"No installed getopts-command."</span> 1&gt;&amp;2
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">shift</span> $((OPTIND - 1))

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">mailtome</span>() {
  local <span style="font-weight: bold; font-style: italic;">_command</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
  local <span style="font-weight: bold; font-style: italic;">_whole_command</span>=$<span style="font-weight: bold; font-style: italic;">2</span>
  local <span style="font-weight: bold; font-style: italic;">_logfile_rel</span>=$<span style="font-weight: bold; font-style: italic;">4</span>

  <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$3"</span> -eq 0 ]; <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold; font-style: italic;">_result</span>=<span style="font-style: italic;">'success'</span>
  <span style="font-weight: bold;">else</span>
    <span style="font-weight: bold; font-style: italic;">_result</span>=<span style="font-style: italic;">'failed'</span>
  <span style="font-weight: bold;">fi</span>
  <span style="font-weight: bold; font-style: italic;">_logfile</span>=$(<span style="font-weight: bold;">type</span> realpath &gt;/dev/null &amp;&amp; realpath <span style="font-style: italic;">"${_logfile_rel}"</span> || <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${_logfile_rel}"</span>)

  <span style="font-weight: bold; font-style: italic;">mailfrom</span>=${<span style="font-weight: bold; font-style: italic;">MAIL_FROM</span>}
  <span style="font-weight: bold; font-style: italic;">mailto</span>=${<span style="font-weight: bold; font-style: italic;">MAIL_TO</span>}
  <span style="font-weight: bold; font-style: italic;">subject</span>=<span style="font-style: italic;">"${_result}: ${_command} @ $(uname -n)"</span>
  <span style="font-weight: bold; font-style: italic;">msg1</span>=<span style="font-style: italic;">"command line      : ${_whole_command}"</span>
  <span style="font-weight: bold; font-style: italic;">msg2</span>=<span style="font-style: italic;">"exit status(nohup): $3"</span>
  <span style="font-weight: bold; font-style: italic;">msg3</span>=<span style="font-style: italic;">"execution time    : $5"</span>
  <span style="font-weight: bold; font-style: italic;">msg4</span>=<span style="font-style: italic;">"pwd               : $(pwd)"</span>
  <span style="font-weight: bold; font-style: italic;">msg5</span>=<span style="font-style: italic;">"Log data (stdout/stderr) is stored in following file:"</span>
  <span style="font-weight: bold; font-style: italic;">msg6</span>=<span style="font-style: italic;">"${_logfile}"</span>

  {
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg1}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg2}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg3}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg4}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg5}"</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${msg6}"</span>
  } | sendmail.py -f <span style="font-style: italic;">"${mailfrom}"</span> -s <span style="font-style: italic;">"${subject}"</span> <span style="font-style: italic;">"${mailto}"</span>
}
<span style="font-weight: bold;">export</span> -f mailtome

<span style="font-weight: bold;">if</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -eq 1 ] &amp;&amp; [ -x <span style="font-style: italic;">"$1"</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">utility</span>=<span style="font-style: italic;">"$1"</span>
<span style="font-weight: bold;">elif</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ] &amp;&amp; <span style="font-weight: bold;">type</span> <span style="font-style: italic;">"$1"</span> &gt;/dev/null; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">utility</span>=<span style="font-style: italic;">"$*"</span>
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">LOG_DIR</span>=${<span style="font-weight: bold; font-style: italic;">HOME</span>}/var/log/$(basename <span style="font-style: italic;">"$0"</span>)
<span style="font-weight: bold; font-style: italic;">fname_default</span>=$(date <span style="font-style: italic;">'+%Y%m%d_%H%M%S'</span>)_$(basename <span style="font-style: italic;">"$0"</span>)-$(basename <span style="font-style: italic;">"$1"</span>)

<span style="font-weight: bold;">if</span> [ ! -d <span style="font-style: italic;">"${LOG_DIR}"</span> ]; <span style="font-weight: bold;">then</span>
  mkdir -p <span style="font-style: italic;">"${LOG_DIR}"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">if</span> [ -v <span style="font-style: italic;">"opt_logfile"</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">logfile</span>=${<span style="font-weight: bold; font-style: italic;">opt_logfile</span>}
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold; font-style: italic;">logfile</span>=<span style="font-style: italic;">"${LOG_DIR}/${fname_default}.log"</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">if</span> [ -v <span style="font-style: italic;">"opt_pidfile"</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;">pidfile</span>=${<span style="font-weight: bold; font-style: italic;">opt_pidfile</span>}
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold; font-style: italic;">pidfile</span>=<span style="font-style: italic;">"${LOG_DIR}/${fname_default}.pid"</span>
<span style="font-weight: bold;">fi</span>

(
  <span style="font-weight: bold; font-style: italic;">start_time</span>=$(date +%s)
  nohup nice -n 10 ${<span style="font-weight: bold; font-style: italic;">utility</span>} &gt;&gt;<span style="font-style: italic;">"${logfile}"</span> &lt;/dev/null 2&gt;&amp;1 &amp;
  <span style="font-weight: bold; font-style: italic;">PID</span>=$<span style="font-weight: bold; font-style: italic;">!</span>
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">PID</span> &gt;<span style="font-style: italic;">"${pidfile}"</span>
  <span style="font-weight: bold;">wait</span> $<span style="font-weight: bold; font-style: italic;">PID</span>
  <span style="font-weight: bold; font-style: italic;">EXIT_STATUS</span>=$<span style="font-weight: bold; font-style: italic;">?</span>
  <span style="font-weight: bold; font-style: italic;">end_time</span>=$(date +%s)
  <span style="font-weight: bold; font-style: italic;">exec_time</span>=$((end_time-start_time))
  ((<span style="font-weight: bold; font-style: italic;">h</span>=exec_time/3600))
  ((<span style="font-weight: bold; font-style: italic;">m</span>=(exec_time%3600)/60))
  ((<span style="font-weight: bold; font-style: italic;">s</span>=exec_time%60))
  <span style="font-weight: bold; font-style: italic;">exec_time_str</span>=$(printf <span style="font-style: italic;">"%02d:%02d:%02d"</span> $<span style="font-weight: bold; font-style: italic;">h</span> $<span style="font-weight: bold; font-style: italic;">m</span> $<span style="font-weight: bold; font-style: italic;">s</span>)
  mailtome <span style="font-style: italic;">"$1"</span> <span style="font-style: italic;">"${utility}"</span> $<span style="font-weight: bold; font-style: italic;">EXIT_STATUS</span> <span style="font-style: italic;">"${logfile}"</span> ${<span style="font-weight: bold; font-style: italic;">exec_time_str</span>}
)
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$1 has finished successfully"</span>

<span style="font-weight: bold;">exit</span> 0
</pre>
</div>
</div>
</div>

<div id="outline-container-org43283be" class="outline-2">
<h2 id="org43283be">sendmail.py</h2>
<div class="outline-text-2" id="text-org43283be">
<p>
Utility for sendind email programatically
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env python3</span>

<span style="font-weight: bold;">import</span> sys
<span style="font-weight: bold;">import</span> argparse
<span style="font-weight: bold;">import</span> subprocess
<span style="font-weight: bold;">import</span> smtplib
<span style="font-weight: bold;">import</span> ssl
<span style="font-weight: bold;">from</span> email.mime.text <span style="font-weight: bold;">import</span> MIMEText
<span style="font-weight: bold;">from</span> email.utils <span style="font-weight: bold;">import</span> formatdate

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">sendmail</span>(mail_to, mail_from, subject, message):
    <span style="font-weight: bold; font-style: italic;">smtp_host</span> = <span style="font-style: italic;">'smtp.daisychain.jp'</span>
    <span style="font-weight: bold; font-style: italic;">smtp_port</span> = <span style="font-style: italic;">'465'</span>
    <span style="font-weight: bold; font-style: italic;">smtp_user</span> = <span style="font-style: italic;">'&lt;&lt;email()&gt;&gt;'</span>.split(sep=<span style="font-style: italic;">'@'</span>)[0]
    <span style="font-weight: bold; font-style: italic;">smtp_pass</span> = subprocess.run([<span style="font-style: italic;">"pass {}:{}/{} | head -1"</span>.<span style="font-weight: bold;">format</span>(smtp_host, smtp_port, smtp_user)], stdout=subprocess.PIPE, shell=<span style="font-weight: bold; text-decoration: underline;">True</span>).stdout.decode().strip()

    <span style="font-weight: bold; font-style: italic;">mime_msg</span> = MIMEText(message)
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">'Subject'</span>] = subject
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">'From'</span>] = mail_from
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">'To'</span>] = mail_to
    <span style="font-weight: bold; font-style: italic;">mime_msg</span>[<span style="font-style: italic;">"Date"</span>] = formatdate(<span style="font-weight: bold; text-decoration: underline;">None</span>, <span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold;">if</span> smtp_port == <span style="font-style: italic;">'465'</span>:
        <span style="font-weight: bold; font-style: italic;">context</span> = ssl.create_default_context()
        <span style="font-weight: bold; font-style: italic;">smtp</span> = smtplib.SMTP_SSL(smtp_host, smtp_port, context=context)

    <span style="font-weight: bold;">if</span> smtp <span style="font-weight: bold;">is</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
        smtp.login(smtp_user, smtp_pass)
        smtp.sendmail(mail_from, mail_to, mime_msg.as_string())
        smtp.<span style="font-weight: bold; text-decoration: underline;">quit</span>()


<span style="font-weight: bold; font-style: italic;">DESC</span> = <span style="font-style: italic;">'sendmail.py sends mail'</span>
<span style="font-weight: bold; font-style: italic;">parser</span> = argparse.ArgumentParser(description=DESC)
parser.add_argument(<span style="font-style: italic;">'-s'</span>, <span style="font-style: italic;">'--subject'</span>)
parser.add_argument(<span style="font-style: italic;">'-f'</span>, <span style="font-style: italic;">'--mailfrom'</span>)
parser.add_argument(<span style="font-style: italic;">'to'</span>)
<span style="font-weight: bold; font-style: italic;">args</span> = parser.parse_args()

<span style="font-weight: bold; font-style: italic;">message</span> = sys.stdin.read()
sendmail(args.to, args.mailfrom, args.subject, message)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda3b3d8" class="outline-2">
<h2 id="orgda3b3d8">pwsudo</h2>
<div class="outline-text-2" id="text-orgda3b3d8">
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>

<span style="font-weight: bold; font-style: italic;">_userid</span>=$(whoami)
<span style="font-weight: bold; font-style: italic;">_hostname</span>=$(hostname)

<span style="font-weight: bold;">if</span> pass show <span style="font-style: italic;">"${_hostname}/${_userid}"</span> &gt;/dev/null 2&gt;&amp;1; <span style="font-weight: bold;">then</span>
  pass show <span style="font-style: italic;">"${_hostname}/${_userid}"</span> | head -1 | sudo -S $<span style="font-weight: bold; font-style: italic;">*</span>
<span style="font-weight: bold;">else</span>
  sudo $<span style="font-weight: bold; font-style: italic;">*</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p>
<p class="validation"></p>
</div>
</body>
</html>
